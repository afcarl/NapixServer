
========================
Install and deploy Napix
========================

.. _installation:

Installation
============

The Napix daemon is hosted in a Mercurial repo at ssh://hg@the-book.enix.org/NapixServer.

.. code-block:: bash

    $ hg clone ssh://hg@the-book.enix.org/NapixServer

Dependencies
^^^^^^^^^^^^

The napix daemon needs

bottle > 0.10
    Lightweight web framework
rocket
    Threaded wsgi server
httplib2
    Http client
redis-python (optional)
    Redis client (for the shared store)
unittest2 (optional)
    Test framework (for the unit tests)
pyinotify (optional)
    Detection of file modification (automatic reloading of modified source files)
sphinx (optional)
    Autogeneration of the documentation

.. code-block:: bash

    # apt-get install python python-virtualenv python-pip
    $ virtualenv napix
    $ source napix/bin/activate
    (napix)$ pip install -r NapixServer/requirements.txt
    (napix)$ NapixServer/bin/napixd


Configuration
=============

Napix takes its configuration in the conf/settings.json.

.. literalinclude:: /samples/settings.json
    :language: javascript


Napix.daemon
^^^^^^^^^^^^

The ``Napix.daemon`` key sets the listen address and port.

Napix.auth
^^^^^^^^^^

The ``Napix.auth`` key sets the value of the authentication server.

The value ``service`` is the **public address** at which the Napix server is accessed.
The client will sign its request with this public address.
The Napix server will check that it is the host at which the request is addressed by comparing its host value and the request host.

The ``auth_url`` value will set the address at which the server will ask for the confirmation of the requests authenticity.


Modules Loading
===============

Loading by the configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The configuration object ``Napix.managers`` is a hashmap
where the keys are an alias and the value is the dotted python path to a Manager.
Multiple instance of a single manager class can be loaded, with different aliases.
The detect (cf :ref:`Auto-loading<auto-loading>`) classmethod is not called.

In order to specify the configuration for an instance of a Manager,
you can add a value in the root object of the configuration.

In this example, two X480 are managed by this Napix server, they use the same manager, and different IP and credentials.

.. literalinclude:: /samples/conf.json
    :language: javascript

.. _auto-loading:

Auto-loading
^^^^^^^^^^^^

If there is a file ending by **.py** in a auto-detect folder
of the Napix setup (/var/lib/napix/auto or NapixServer/auto),
the Napix loader will import this python file and add all the subclasses of :py:class:`managers.Manager` in the available managers.
The auto loaded managers may override the classmethod :py:meth:`~managers.Manager.detect`
which tells if the managers should be loaded.
By default detect return True when the class is not a base method defined inside Napix.


This feature does not allow neither multiple loading of the same manager nor the configuration.

Reloading
^^^^^^^^^

Napix proposes an option to reload the modules without stopping the server.
When the reload is triggered, the configuration is reparsed.
The autoload directories are scanned again.

The automatic reloading is disabled when Napix.loader.reload is set to false.

GET /_napix_reload
..................

When the server is on DEBUG mode, a simple GET on /_napix_reload will trigger a reload.
It is useful for a developer, he just refreshes /_napix_reload then refreshes his page.

Send a SIGHUP signal
....................

Sending a SIGHUP to the server will cause it to reload.

.. code-block:: none

    $ ps aux  | grep napixd
    napixd     13651  0.5  2.4  81000 12560 pts/3    Sl+  05:24   0:17 python bin/napixd
    $ kill -HUP 13651

Use inotify
...........

When inotify is available through ``pyinotify``,
it will listen on the filesystem changes to check if the auto-loaded directories changed,
and it will then issue a reload.

