<!DOCTYPE html>
<html>
    <head>
        <title>Napix Web Help</title>
        <link href="../css/help.css" rel="stylesheet"/>
        <script data-main="js/help" src="js/libs/require/require.js" ></script>
        <style>
            body {
                margin-top: 100px;
                margin-bottom: 200px;
            }
        </style>
    </head>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a href="." class="brand" >Napix Help</a>
                    <ul class="nav">
                        <li> <a href="high_level.html">Writing a Napix module</a> </li>
                        <li> <a href="low_level.html">Low level interface</a> </li>
                        <li> <a href="deploy.html">Deployment</a> </li>
                        <li> <a href="executor.html">Process and threads</a> </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="container">
            <h1>Howto write Napix modules</h1>
            <p>
            In this howto you will learn to write a quick Napix module.
            In order to write this module you have to write a <strong>manager</strong>
            and install it in the Napix server.
            A Napix module may be in every place that is accessible in the python path.
            However it is recommended to keep them in <strong>/var/lib/napix/auto</strong>.
            </p>
            <p>
            For this example we will be write a manager for the hosts file.
            So we create the file sample1.py in /var/lib/napix/auto.
            </p>
            <h2 id="writing" >Writing the module</h2>
            <h3 id="writing-class">Napix Class</h3>
            <p>
            DictManager is the base class of the manager we will be writing.
            This abstract class define three methods and an attribute :
            </p>
            <dl>
                <dt>load ( <em>parent</em> ) -&gt; <em>resources</em> </dt>
                <dd>
                Gets the mapping of the <em>resources</em> managed by our class.
                Each key of the mapping is a url identifier.
                The method gets a <em>parent</em> parameter which is the parent resource
                </dd>
                <dt>save ( <em>parent</em>, <em>resources</em> ) </dt>
                <dd>Persist the <em>resources</em>.
                The <em>parent</em> parameter is the same that was passed when load was called</dd>
                <dt>generate_new_id( <em>resource_dict</em> ) -&gt; <em>id</em> </dt>
                <dd>
                Generate and return the <em>id</em> from the dictionary of data <em>resource_dict</em> the user sent with his creation request.
                This id will be the identifier of the created resource.
                </dd>
                <dt> resource_fields</dt>
                <dd>
                <em>Resource_fields</em> is an attribute of the class that defines the keys exported by the resources
                generated by the manager.
                </dd>
            </dl>
            <p>
            For the hosts example, we will write an implementation of this class.
            We add a docstring for our class.
            It will be used by napix to document the service.
            </p>
            <!-- Code class -->
            <div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">napixd.managers.default</span> <span class="kn">import</span> <span class="n">DictManager</span>

<span class="k">class</span> <span class="nc">HostManager</span><span class="p">(</span><span class="n">DictManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Napix Web service to manage the content of the hosts file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FILE_PATH</span>  <span class="o">=</span> <span class="s">&#39;/etc/hosts&#39;</span>
</pre></div>
            <h3 id="writing-data">Writing the meta-datas</h3>
            <p>
            First you need to write the resource_fields attribute that describes the resource.
            </p>
            <p>
            For our example, we will use two fields: a string for the IP address and an array of hostnames
            related to this IP.
            For each of our field, we add a field in the resource_fields dictionary containing another dict
            describing the field. We add a description and an example.
            </p>
            <div class="alert alert-info">
                <h4>NB:</h4>
                The example key is not a default value, it's used when the user requests a example object
                as a template to create a new one and for documentation purposes.
            </div>
            <!-- Code resource_fields -->
            <div class="highlight"><pre><span class="n">resource_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;hostnames&#39;</span><span class="p">:{</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;List of hostname resolving to that IP&#39;</span><span class="p">,</span>
            <span class="s">&#39;example&#39;</span><span class="p">:[</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="s">&#39;localhost.localdomain&#39;</span><span class="p">]</span>
            <span class="p">},</span>
        <span class="s">&#39;ip&#39;</span><span class="p">:{</span>
            <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;IP of the host&#39;</span><span class="p">,</span>
            <span class="s">&#39;example&#39;</span><span class="p">:</span><span class="s">&#39;127.0.0.1&#39;</span>
            <span class="p">},</span>
        <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="p">}</span>
        <span class="p">}</span>
</pre></div>
            <h3 id="writing-load">Loading the resources </h3>
            <p>
            In order to get the resources, you have to define the load method.
            This method must return a dictionary of the resources indexed by their keys.
            </p>
            <p>
            For the manager we are writing, we will use the line number as an index.
            Since we install our manager in the root of the service,
            we will ignore the parent parameter in the load and save methods.
            </p>
            <!-- Code load -->
            <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span> <span class="p">):</span>
        <span class="c">#open the hosts file and keep a copy</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">#filter empty and commented lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_content</span> <span class="ow">or</span> <span class="n">line_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">line_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">))</span>
            <span class="c"># Store ID as strings</span>
            <span class="n">resources</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c">#first token on the host file is the ip</span>
                    <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="c">#remaining is the list of hostnames</span>
                    <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">resources</span>
</pre></div>
            <h3 id="writing-creating">Creating resources</h3>
            <p>
            At this point, the resources can be listed, got, deleted and modified.
            In order to add new resources, the manager must be able to generate the corresponding ID
            of a new resources.
            You have to write the method generate_new_id that will return the id of the new resource
            knowing its dictionary.
            </p>
            <p>
            You may choose to get a UUID, a sequence number, a value from the dictionary, etc,
            as long as this id will allow to query the same object in the future, and will be persisted.
            </p>
            <p>
            In the manager we're writing, we are using the line number as identifier,
            so we will use the size of the file we already have.
            </p>
            <!-- Code generate_new_id -->
            <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">generate_new_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">resource_dict</span><span class="p">):</span>
        <span class="c">#In order to avoid concurrency issue we add a blank line</span>
        <span class="c"># in the lines attribute so that another call</span>
        <span class="c"># may not give the same line number</span>

        <span class="c">#force load to be run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="c">#Add an empty line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c">#return the position of that line</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
            <h3 id="writing-persist">Persisting the resources</h3>
            <p>
            The data can now be queried, modified, removed, added.
            In order to persist the modifications in the time, you will have to write a save method that will persist
            the data you modified.
            At every call of persist, you will save all the resources of the manager,
            not only those which have been modified.
            </p>
            <p>
            For the files manager, we will write the hosts files.
            As with the load method, we don't need the parent parameter, so it will be ignored.
            </p>
            <!-- Code save -->
            <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">new_file_content</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">original</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c">#Keep the comments in the file</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">stripped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span>  <span class="n">original</span>
                <span class="k">continue</span>

            <span class="n">res_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">res_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource existed and has been removed</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;#;deleted: &#39;</span> <span class="o">+</span> <span class="n">original</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource exists and may have been modified</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;ip&#39;</span> <span class="p">],</span>
                    <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;hostnames&#39;</span> <span class="p">]),</span>
                    <span class="p">))</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">new_file_content</span><span class="p">))</span>
</pre></div>
            <h3 id="writing-final">Resulting file</h3>
            <!-- Code total -->
            <div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">napixd.managers.default</span> <span class="kn">import</span> <span class="n">DictManager</span>

<span class="k">class</span> <span class="nc">HostManager</span><span class="p">(</span><span class="n">DictManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Napix Web service to manage the content of the hosts file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FILE_PATH</span>  <span class="o">=</span> <span class="s">&#39;/etc/hosts&#39;</span>
    <span class="n">resource_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;hostnames&#39;</span><span class="p">:{</span>
                <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;List of hostname resolving to that IP&#39;</span><span class="p">,</span>
                <span class="s">&#39;example&#39;</span><span class="p">:[</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="s">&#39;localhost.localdomain&#39;</span><span class="p">]</span>
                <span class="p">},</span>
            <span class="s">&#39;ip&#39;</span><span class="p">:{</span>
                <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;IP of the host&#39;</span><span class="p">,</span>
                <span class="s">&#39;example&#39;</span><span class="p">:</span><span class="s">&#39;127.0.0.1&#39;</span>
                <span class="p">},</span>
            <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span> <span class="p">):</span>
        <span class="c">#open the hosts file and keep a copy</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">#filter empty and commented lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_content</span> <span class="ow">or</span> <span class="n">line_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">line_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">))</span>
            <span class="c"># Store ID as strings</span>
            <span class="n">resources</span><span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">lineno</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c">#first token on the host file is the ip</span>
                    <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="c">#remaining is the list of hostnames</span>
                    <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">generate_new_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">resource_dict</span><span class="p">):</span>
        <span class="c">#In order to avoid concurrency issue we add a blank line</span>
        <span class="c"># in the lines attribute so that another call</span>
        <span class="c"># may not give the same line number</span>

        <span class="c">#force load to be run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="c">#Add an empty line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c">#return the position of that line</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">new_file_content</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">original</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c">#Keep the comments in the file</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">stripped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span>  <span class="n">original</span>
                <span class="k">continue</span>

            <span class="n">res_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">res_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource existed and has been removed</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;#;deleted: &#39;</span> <span class="o">+</span> <span class="n">original</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource exists and may have been modified</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;ip&#39;</span> <span class="p">],</span>
                    <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;hostnames&#39;</span> <span class="p">]),</span>
                    <span class="p">))</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">new_file_content</span><span class="p">))</span>
</pre></div>
            <h2 id="valid">Validation</h2>
            <p>
            The user's input of our Napix modules may be checked by writing validation methods.
            They take the proposed user input as an entry and return the correct data.
            There's two kind of input to validate or transform:
            <ol>
                <li> the input given by the user when he tries
                to create or transform the data of the resources </li>
                <li> the id that the user wants to query, for example http://napix.server.com/manager/<strong>resource_id1</strong>.</li>
            </ol>
            </p>
            <h3 id="valid-id">URL token validation</h3>
            <p>
            The method that checks the url token before trying to access it is <em>validate_id</em>.
            It takes the proposed user input and return the correct user input or, if it's wrong,
            raises a ValidationError with a message describing the kind of error that has been done.

            It mays change the type of the variable, which can be useful for example
            to change number strings to integer values to query integer indexed values.
            </p>
            <p>
            In our example, we may want to keep the id as integers
            </p>
            <div class="alert">
                <h4>It's not the time to check for the existence</h4>
                <p>
                This method should just check that the ID may be a valid ID for the rest of the methods.
                It's not the methods in which you should check that a value already exists or not.
                </p>
            </div>
<div class="highlight"><pre>
    <span class="kn">from</span> <span class="nn">napixd.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
    <span class="k">def</span> <span class="nf">validate_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span> <span class="n">id_</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;id have to be integer values&#39;</span>
</pre></div>
            <div class="alert alert-info">
                In order to make this snippet working, you have to remove the str in <em>load</em>, <em>save</em> and <em>generate_new_id</em>
            </div>
            <h3 id="valid-input">Request body validation</h3>
            <p>
            There is two places where the strings are validated.
            First in the <strong>validate_resource_<em>field_name</em></strong> methods that check each field individually.
            Then in the <strong>validate_resource</strong> that validate the whole data dictionary.
            It may be used to convert integers to strings, clean a string, ensure consistency etc.
            </p>
            <p>
            Those methods get the object (the whole dict or each field) to validate by argument and must return the correct value.
            When a value is incorrect, the method throws a ValidationError
            with a string describing the kind of error the user did.
            </p>
            <p>
            With the HostManager, we may want to check that users are sending an array of strings as the hostnames attribute
            and a valid and clean IP address for the ip attribute.
            </p>
<div class="highlight"><pre>
    <span class="kn">from</span> <span class="nn">napixd.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
    <span class="k">def</span> <span class="nf">validate_resource_hostnames</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hostnames</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">hostnames</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hostnames</span> <span class="p">])):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Hostnames have to be an array of strings&#39;</span>
        <span class="k">return</span> <span class="n">hostnames</span>

    <span class="k">def</span> <span class="nf">validate_resource_ip</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;ip have to be a string&#39;</span>
        <span class="n">ip_components</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_components</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c"># 123.45.67 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 1&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip_components</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">ip_components</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c">#123.45.lol.99 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 2&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_components</span><span class="p">]):</span>
            <span class="c">#123.45.67.890 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 3&#39;</span>
        <span class="c">#filter the useless 0 out of 123.045.012.001</span>
        <span class="k">return</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">ip_components</span><span class="p">))</span>
</pre></div>
            <h3 id="valid-finish">Resulting file</h3>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">napixd.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">napixd.managers.default</span> <span class="kn">import</span> <span class="n">DictManager</span>

<span class="k">class</span> <span class="nc">HostManager</span><span class="p">(</span><span class="n">DictManager</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Napix Web service to manage the content of the hosts file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">FILE_PATH</span>  <span class="o">=</span> <span class="s">&#39;/etc/hosts&#39;</span>
    <span class="n">resource_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;hostnames&#39;</span><span class="p">:{</span>
                <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;List of hostname resolving to that IP&#39;</span><span class="p">,</span>
                <span class="s">&#39;example&#39;</span><span class="p">:[</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span><span class="s">&#39;localhost.localdomain&#39;</span><span class="p">]</span>
                <span class="p">},</span>
            <span class="s">&#39;ip&#39;</span><span class="p">:{</span>
                <span class="s">&#39;description&#39;</span><span class="p">:</span><span class="s">&#39;IP of the host&#39;</span><span class="p">,</span>
                <span class="s">&#39;example&#39;</span><span class="p">:</span><span class="s">&#39;127.0.0.1&#39;</span>
                <span class="p">},</span>
            <span class="s">&#39;description&#39;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="p">}</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span> <span class="p">):</span>
        <span class="c">#open the hosts file and keep a copy</span>
        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">line_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="nb">map</span><span class="p">(</span> <span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c">#filter empty and commented lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line_content</span> <span class="ow">or</span> <span class="n">line_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">line_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span> <span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">))</span>
            <span class="c"># Store ID as strings</span>
            <span class="n">resources</span><span class="p">[</span> <span class="n">lineno</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="c">#first token on the host file is the ip</span>
                    <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="c">#remaining is the list of hostnames</span>
                    <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">}</span>
        <span class="k">return</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">generate_new_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">resource_dict</span><span class="p">):</span>
        <span class="c">#In order to avoid concurrency issue we add a blank line</span>
        <span class="c"># in the lines attribute so that another call</span>
        <span class="c"># may not give the same line number</span>

        <span class="c">#force load to be run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="c">#Add an empty line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="c">#return the position of that line</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">new_file_content</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">original</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">stripped</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c">#Keep the comments in the file</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">stripped</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;#&#39;</span><span class="p">:</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span>  <span class="n">original</span>
                <span class="k">continue</span>

            <span class="n">res_id</span> <span class="o">=</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">stripped</span> <span class="ow">and</span> <span class="n">res_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource existed and has been removed</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;#;deleted: &#39;</span> <span class="o">+</span> <span class="n">original</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">res_id</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
                <span class="c">#the resource exists and may have been modified</span>
                <span class="n">new_file_content</span><span class="p">[</span><span class="n">lineno</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;ip&#39;</span> <span class="p">],</span>
                    <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">resources</span><span class="p">[</span> <span class="n">res_id</span> <span class="p">][</span> <span class="s">&#39;hostnames&#39;</span> <span class="p">]),</span>
                    <span class="p">))</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">new_file_content</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_resource_hostnames</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">hostnames</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">hostnames</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hostnames</span> <span class="p">])):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Hostnames have to be an array of strings&#39;</span>
        <span class="k">return</span> <span class="n">hostnames</span>

    <span class="k">def</span> <span class="nf">validate_resource_ip</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span> <span class="n">ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;ip have to be a string&#39;</span>
        <span class="n">ip_components</span> <span class="o">=</span> <span class="n">ip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ip_components</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c"># 123.45.67 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 1&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ip_components</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="n">ip_components</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c">#123.45.lol.99 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 2&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_components</span><span class="p">]):</span>
            <span class="c">#123.45.67.890 is not an ip</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;Not an ip 3&#39;</span>
        <span class="c">#filter the useless 0 out of 123.045.012.001</span>
        <span class="k">return</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">ip_components</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">validate_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span> <span class="n">id_</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">,</span> <span class="s">&#39;id have to be integer values&#39;</span>
</pre></div>
            <h2 id="deploy">Deployment and configuration</h2>
            <h3 id="deploy-napix">Install into Napix</h3>
            <p>
            To add the new module to the Napix server, you need to add the path to its class in
            the configuration file: <strong>conf/settings.json</strong>.
            </p>
            <p>
            The key <em>Napix.Manager</em> hold a dictionary of the activated modules.
            The key of this dict is the alias of the module, and the value is the path to the module.
            </p>
            <p>
            Mutliple aliases may refer to the same class, then it will launch multiples instances of the manager.
            It may be useful for example to load multiple hosts managers for differents hosts files.
            </p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;Napix.Manager&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;hosts&quot;</span> <span class="o">:</span> <span class="s2">&quot;sample1.HostManager&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
            <h3 id="deploy-conf">Configuration</h3>
            <p>
            The Napix managers have a method configure that does nothing by default but is called
            with the configuration of the module if any.
            </p>
            <p>
            You may override the configure method of a Napix manager <strong>configure</strong>( <em>conf</em> )
            </p>
            <p>
            For the HostManager we may add a configuration option to set another hosts file path.
            We may also configure the <em>url</em> settings that define on which url the service will be waiting.
            </p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;Napix.Manager&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;hosts&quot;</span> <span class="o">:</span> <span class="s2">&quot;sample1.HostManager&quot;</span>
    <span class="p">}</span>
    <span class="s2">&quot;hosts&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;url&quot;</span> <span class="o">:</span> <span class="s2">&quot;hosts&quot;</span><span class="p">,</span>
        <span class="s2">&quot;file_path&quot;</span> <span class="o">:</span> <span class="s2">&quot;/usr/etc/hosts&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
            <p>
            The configure method get the dictionary that we set in <em>conf/settings.json</em>.
            </p>
<div class="highlight"><pre>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span> <span class="s">&#39;file_path&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="p">)</span>
</pre></div>
            <h2 id="testing">Test case</h2>
            <p>
            Testing the module is quite easy.
            You instantiate a manager with its parent resource if it has one, then you can test the behavior
            with of the load and save methods.
            </p>
<div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">sample1</span> <span class="kn">import</span> <span class="n">HostManager</span>
<span class="kn">from</span> <span class="nn">napixd.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="k">class</span> <span class="nc">TestHostFile</span><span class="p">(</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">SAMPLE_FILE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="s">&#39;/dev/shm&#39;</span><span class="p">,</span>
                <span class="s">&#39;napix_sample_hosts&#39;</span><span class="p">)</span>
    <span class="n">SAMPLE_CONTENT</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">127.0.0.1 localhost</span>

<span class="s">#A.com and its alias</span>
<span class="s">127.0.0.2 a.com www.a.com</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_CONTENT</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">HostManager</span><span class="p">(</span> <span class="bp">None</span> <span class="p">)</span>
        <span class="n">HostManager</span><span class="o">.</span><span class="n">FILE_PATH</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span>
    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_load</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resources</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="mi">2</span> <span class="p">:</span> <span class="p">{</span>
                        <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
                        <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s">&#39;localhost&#39;</span> <span class="p">]</span>
                        <span class="p">},</span>
                    <span class="mi">5</span> <span class="p">:</span> <span class="p">{</span>
                        <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="s">&#39;127.0.0.2&#39;</span><span class="p">,</span>
                        <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="p">[</span> <span class="s">&#39;a.com&#39;</span><span class="p">,</span> <span class="s">&#39;www.a.com&#39;</span> <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">})</span>
    <span class="k">def</span> <span class="nf">test_get_new_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">generate_new_id</span><span class="p">({}),</span> <span class="mi">6</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_noop_save</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_CONTENT</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_delete_save</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">delete_resource</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">#;deleted: 127.0.0.1 localhost</span>

<span class="s">#A.com and its alias</span>
<span class="s">127.0.0.2 a.com www.a.com</span>
<span class="s">&quot;&quot;&quot;</span>
                <span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_modify_save</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">modify_resource</span><span class="p">(</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="p">{</span> <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span>
                    <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&#39;localhost&#39;</span><span class="p">,</span> <span class="s">&#39;localhost.com&#39;</span><span class="p">]</span>
                <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">127.0.0.1 localhost localhost.com</span>

<span class="s">#A.com and its alias</span>
<span class="s">127.0.0.2 a.com www.a.com</span>
<span class="s">&quot;&quot;&quot;</span>
                <span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_create_resource</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">create_resource</span><span class="p">(</span>
                <span class="p">{</span> <span class="s">&#39;ip&#39;</span> <span class="p">:</span> <span class="s">&#39;8.8.8.8&#39;</span><span class="p">,</span>
                    <span class="s">&#39;hostnames&#39;</span> <span class="p">:</span> <span class="p">[</span><span class="s">&#39;google-public-dns-a.google.com&#39;</span><span class="p">]</span>
                    <span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="nb">open</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">SAMPLE_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">127.0.0.1 localhost</span>

<span class="s">#A.com and its alias</span>
<span class="s">127.0.0.2 a.com www.a.com</span>
<span class="s">8.8.8.8 google-public-dns-a.google.com</span>
<span class="s">&quot;&quot;&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_validate_resource</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_hostnames</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;host1&#39;</span><span class="p">]),</span>
                <span class="p">[</span><span class="s">&#39;host1&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertListEqual</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_hostnames</span><span class="p">(</span> <span class="p">[</span><span class="s">&#39;host1&#39;</span><span class="p">,</span> <span class="s">&#39;host2&#39;</span><span class="p">]),</span>
                <span class="p">[</span><span class="s">&#39;host1&#39;</span><span class="p">,</span> <span class="s">&#39;host2&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span> <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_hostnames</span><span class="p">,</span>
                <span class="p">[</span> <span class="s">&#39;host1&#39;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span> <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_hostnames</span><span class="p">,</span>
                <span class="s">&#39;host1&#39;</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_validate_ip</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_ip</span><span class="p">(</span> <span class="s">&#39;127.0.0.1&#39;</span> <span class="p">),</span>
                <span class="s">&#39;127.0.0.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_ip</span><span class="p">(</span> <span class="s">&#39;1.10.0.01&#39;</span> <span class="p">),</span>
                <span class="s">&#39;1.10.0.1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_ip</span><span class="p">,</span>
                <span class="s">&#39;1.2.3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_ip</span><span class="p">,</span>
                <span class="s">&#39;1.2.3.10000&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_resource_ip</span><span class="p">,</span>
                <span class="s">&#39;1.2.3.lol&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_validate_id</span><span class="p">(</span> <span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_id</span><span class="p">(</span><span class="s">&#39;1&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_id</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_id</span><span class="p">,</span> <span class="s">&#39;lpm&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
                <span class="n">ValidationError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">validate_id</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
            </div>
        </div>
    </body>
</html>
