require.config({paths:{order:"libs/order",bootstrap:"bootstrap.min",jQuery:"libs.min",underscore:"libs.min",Backbone:"libs.min",jsSHA:"libs.min",localstorage:"libs.min",selecteditem:"libs.min","json/editor":"json.min","json/viewer":"json.min","models/consoleentries":"models.min","models/history":"models.min","models/credentials":"models.min","models/servers":"models.min",napixclient:"models.min","libs/backbone/backbone":"libs/backbone.min","libs/underscore/underscore":"libs/underscore.min","libs/jquery/jquery":"libs/jquery.min","libs/jssha/sha256":"libs/sha256.min",selectors:"app.min",explorer:"app.min","napix-ui":"app.min",console:"app.min",consoleactions:"app.min"}});define("main",["Backbone","jQuery","napix-ui"],function(c,a,b){a(document).ready(function(){var d=new b();c.history.start()})});require(["main"]);define("explorer",["Backbone","jQuery","underscore","napixclient","json/viewer","json/editor"],function(f,i,r,m,b,d){var k=f.View.extend({tagName:"div",initialize:function(s,t){this.path=s;this.parentMetaData=t;if(r.isNull(t)){m.getLevel(this.path,this.gotMetaData.bind(this))}else{if(r.isString(t)){m.getLevel(t+"/"+(this.path.split("/").pop()),this.gotMetaData.bind(this))}else{if(t.direct_plug==true){m.getGenericLevel(this.path,this.gotMetaData.bind(this))}else{if(t.direct_plug==false){r.defer(this.gotMetaData.bind(this,t.absolute_url))}}}}},render:function(){i("<div />",{"class":"explorer-header"}).append(i("<i />",{"class":"deploy"})).append(i("<span />",{text:this.path,"class":"path"}).click(this.selectObject.bind(this))).appendTo(this.el);return this},getList:function(){m.GET(this.path+"/",this.gotList.bind(this))},gotList:function(t){var s=this.$(".explorer-content").first().empty();this.$(".deploy").first().addClass("icon-minus");this.contentViews=r(t).chain().filter(function(u){return u.search("/_napix")==-1}).map(function(v){var u=new k(v,this.metaData);u.bind("select",this.refire,this);s.append(u.render().el);return u},this).map(function(u){return[u.path,u]}).objectify().value();this.trigger("gotList",this.contentViews);this.unbind("gotList")},gotMetaData:function(s){this.metaData=s||null;i("<div />",{"class":"explorer-content"}).appendTo(this.el);this.$(".deploy").first().addClass("icon-plus").click(this.toggleContent.bind(this));this.trigger("gotMetaData");this.unbind("gotMetaData")},getObject:function(){if(!r.isString(this.parentMetaData)){m.GET(this.path,this.gotObject.bind(this))}else{this.gotObject()}},gotObject:function(s){if(s){this.object=s}this.trigger("select",this)},selectObject:function(){if(r.isUndefined(this.object)){this.object=null;this.getObject()}else{this.gotObject()}},toggleContent:function(t){if(!this.filled){this.filled=true;this.getList()}else{if(r.isBoolean(t)){this.$(".explorer-content").first().toggle(t);this.$(".deploy").first().addClass(t?"icon-plus":"icon-minus")}else{var s=this.$(".explorer-content").first().toggle().css("display")=="none";this.$(".deploy").first().addClass(s?"icon-plus":"icon-minus").removeClass(s?"icon-minus":"icon-plus")}}},refire:function(s){this.trigger("select",s)},setSelected:function(s){this.$(".explorer-header").first().toggleClass("selected",s)},refreshObject:function(){delete this.object;this.selectObject()},refreshContent:function(){this.filled=false;this.toggleContent()},goToPath:function(t){if(this.path==t){this.selectObject()}else{if(t.search(this.path)==0){if(this.metaData){this.toggleContent(true)}else{this.bind("gotMetaData",this.toggleContent.bind(this))}var s=function(u){r.any(u,function(v,w){if(t.search(w)==0){v.goToPath(t);return true}return false})};if(this.contentViews){s(this.contentViews)}else{this.bind("gotList",s)}}}}});var p=f.View.extend({initialize:function(){this.deployed=false},render:function(){this.$el.append(i("<div />",{text:"/"}).one("click",this.deploy.bind(this))).append(i("<div />",{"class":"explorer-content"}));return this},goToPath:function(t){this.deploy();var s=function(u){r.any(u,function(v,w){if(t.search(w)==0){v.goToPath(t);return true}return false})};if(this.views){s(this.views)}else{this.bind("gotList",s)}},deploy:function(){if(!this.deployed){m.GET("/",this.gotList.bind(this));this.deployed=true}},gotList:function(t){var s=this.$(".explorer-content");this.views=r(t).chain().map(function(v){var u=new k(v,null);u.bind("select",this.refire,this);s.append(u.render().el);return u},this).map(function(u){return[u.path,u]}).objectify().value();this.trigger("gotList",this.views);this.unbind("gotList")},refire:function(s){this.trigger("select",s)}});var n=f.View.extend({tagName:"em",render:function(){this.$el.text("empty");return this}});var o=f.View.extend({id:"",emptyView:n,initialize:function(){this.setElement(i("#"+this.id));this.shown=false;this.rendered=false;this.view=new this.emptyView();i("#"+this.id+"-label").bind("shown",this.show.bind(this)).bind("hidden",this.hide.bind(this))},gotObject:function(s){this.rendered=false;this.view=s?new this.insideView(s):new this.emptyView();return this.render()},render:function(){if(!this.rendered&&this.shown){this.rendered=true;this.actuallyRender()}return this},actuallyRender:function(){this.$el.empty().append(this.view.render().el);this.trigger("rendered",this.view)},available:function(s){i("#"+this.id+"-label").toggle(Boolean(s));if(!s){this.shown=false}},hide:function(){this.shown=false;return this},show:function(){this.shown=true;this.render();return this}});var j=o.extend({id:"explorer-object",insideView:b,gotObject:function(t,s){this.path=s.path;this.actions=s.actions;this.deletable=s.deletable;this.editable=s.editable;j.__super__.gotObject.call(this,t);return this},actuallyRender:function(){j.__super__.actuallyRender.call(this);var s=i("<div />",{id:"explorer-object-actions","class":"btn-group"}).appendTo(this.el);if(this.actions){r.each(this.actions,function(t){i("<button />",{text:t,"class":"btn"}).click(r.bind(this.trigger,this,"action",t,this.path)).appendTo(s)},this)}if(this.deletable){i("<button />",{text:"Delete","class":"btn btn-danger"}).click(r.bind(this.trigger,this,"delete",this.path)).appendTo(s)}if(this.editable){i("<button />",{text:"Edit","class":"btn"}).click(r.bind(this.trigger,this,"edit",this.path)).appendTo(s)}return this}});var l=o.extend({id:"explorer-help",insideView:b});var e=o.extend({insideView:d,initialize:function(){e.__super__.initialize.call(this);this.bind("rendered",this.onRender,this)},gotObject:function(t,s){this.path=s.path;e.__super__.gotObject.call(this,t)},onRender:function(s){s.bind("validate",r.bind(this.trigger,this,"validate",this.path))}});var a=e.extend({id:"explorer-edit"});var c=f.View.extend({initialize:function(s){this.collectionPath=s},render:function(){m.getNewObject(this.collectionPath,this.gotTemplate.bind(this));return this},gotTemplate:function(t){var s=new d(t);i(this.el).append(s.render().el);s.bind("validate",r.bind(this.trigger,this,"validate"))}});var h=e.extend({id:"explorer-create",insideView:c});var q=f.View.extend({className:"alert alert-info",initialize:function(t,s){this.path=t;this.action=s;this.actionUrl=this.path+"/_napix_action/"+this.action;this.optionnalView=null;this.mandatoryView=null},render:function(){m.GET(this.actionUrl+"/_napix_help",this.gotActionMetaData.bind(this));this.$el.empty().append(i("<h3 >",{text:this.path+" - "+this.action})).append(i("<a />",{"class":"close","data-dismiss":"alert",text:"X"}));return this},gotActionMetaData:function(s){var u=r.reduce(s.mandatory,function(w,v){w[v]="";return w},{});var t=i("<div />",{"class":"content json"});if(!r.isEmpty(u)){this.mandatoryView=new d.defaultView(u).disableAddKey();t.append(i("<h4 />",{text:"Mandatory parameters"})).append(this.mandatoryView.render().el)}if(!r.isEmpty(s.optional)){this.optionnalView=new d.defaultView(s.optional).disableAddKey();t.append(i("<h4 />",{text:"Optionnal parameters"})).append(this.optionnalView.render().el)}t.append(i("<button />",{text:"Valider","class":"btn validate"}).click(this.validate.bind(this)));this.$el.append(t);this.$("input,button.validate").first().focus()},validate:function(){m.POST(this.actionUrl,this.getValue(),this.gotResult.bind(this))},gotResult:function(s){this.$(".content").empty().append(new b(s).render().el)},getValue:function(){return r.extend(this.mandatoryView&&this.mandatoryView.getValue()||{},this.optionnalView&&this.optionnalView.getValue()||{})}});var g=f.View.extend({initialize:function(){this.setElement(i("#explorer"));this.object=new j();this.help=new l();this.edit=new a();this.create=new h();m.bind("error",this.gotError,this);this.edit.bind("validate",this.sendPUT,this);this.edit.available(false);this.create.bind("validate",this.sendPOST,this);this.object.bind("edit",this.showEdit,this).bind("delete",this.sendDELETE,this).bind("action",this.callAction,this).show();i('#explorer-tabs a[data-toggle="tab"]').bind("show",this.changeTab.bind(this));m.bind("change",this.selectServer,this);this.currentView=null;this.rootView=null},changeTab:function(s){i(s.relatedTarget).trigger("hidden")},showEdit:function(){i("#explorer-edit-label").tab("show")},goToPath:function(s){if(this.rootView){this.rootView.goToPath(s)}else{this.bind("selectServer",function(){this.rootView.goToPath(s)}.bind(this))}},gotError:function(t,u,s){i("<div />",{"class":"alert alert-block alert-error"}).append(i("<a />",{"class":"close","data-dismiss":"alert",text:"X"})).append(i("<h4 />",{"class":"error-msg",text:t+" "+u})).append(r.isString(s)&&i("<span />",{text:s})||!r.isEmpty(s)&&s.jquery&&s||new b(s).render().el).prependTo(this.el)},selectServer:function(s){i("#server").text(s.getConnectionString());this.rootView=new p();this.rootView.bind("select",this.select,this);i("#explorer-server").empty().append(this.rootView.render().el);this.trigger("selectServer");this.unbind("selectServer")},select:function(s){if(this.currentView!=null){this.currentView.setSelected(false)}s.setSelected(true);this.create.available(s.metaData&&r.contains(s.metaData.collection_methods,"POST"));this.object.gotObject(s.object,{path:s.path,actions:s.parentMetaData&&s.parentMetaData.actions||[],editable:Boolean(s.parentMetaData&&r.contains(s.parentMetaData.resource_methods,"PUT")),deletable:Boolean(s.parentMetaData&&r.contains(s.parentMetaData.resource_methods,"DELETE"))});this.edit.gotObject(s.object,{path:s.path});this.help.gotObject(s.metaData&&!r.isString(s.metaData)?s.metaData:s.parentMetaData);this.create.gotObject(s.path,{path:s.path});i("#explorer-object-label").tab("show");this.currentView=s;this.trigger("selected",s.path)},sendPUT:function(t,s){m.PUT(t,s,this.currentView.refreshObject.bind(this.currentView))},sendPOST:function(t,s){console.log("path",t);console.log("object",s);m.POST(t+"/",s,function(){this.currentView.refreshContent();this.alertOk();this.object.show()}.bind(this))},sendDELETE:function(s){m.DELETE(s,r.bind(this.goToPath,this,s.split("/").slice(0,-1).join("/")))},alertOk:function(){i("<div />",{"class":"alert alert-block alert-info"}).append(i("<a />",{"class":"close","data-dismiss":"alert",text:"X"})).append(i("<h4 />",{text:"Done"})).prependTo(this.el)},callAction:function(s,t){new q(t,s).render().$el.prependTo(this.el)}});return g});define("console",["Backbone","underscore","jQuery","json/viewer","models/history","models/consoleentries","consoleactions"],function(l,m,f,c,e,n,b){var a=l.View.extend({tagName:"div",className:"console-entry-text",render:function(){this.$el.text(this.model.get("text"));return this}});var d=a.extend({tagName:"pre"});var k=l.View.extend({className:"console-entry-query",render:function(){this.$el.append(f("<span />",{text:">>>"})).append(this.model.get("text"));return this}});var h=l.View.extend({render:function(){var o=this.model.get("text");this.$el.append(new c(o).render().el);return this}});var i=l.View.extend({initialize:function(o){this.inside=i.getView(o);this.setElement(this.inside.el)},render:function(){this.inside.render();this.$el.addClass("console-entry");return this}},{getView:function(o){if(o.get("level") in this.viewsMap){return new this.viewsMap[o.get("level")]({model:o})}return new this.defaultView({model:o})},viewsMap:{query:k,help:d,json:h},defaultView:a});var j=l.View.extend({initialize:function(){this.setElement(f("#console-input"));this.focus();this.keymap=this.getKeyMap();this.$el.keypress(this.onKeyPress.bind(this));f("#console-go").click(this.validate.bind(this));this._historyPosition=-1;this._historyStore=""},getKeyMap:function(){return{13:this.validate,38:this.historyUp,40:this.historyDown}},onKeyPress:function(o){var p=this.keymap[o.keyCode];if(p){p.call(this)}},historyUp:function(){if(!e.hasMore(this._historyPosition)){return}if(this._historyPosition==-1){this._historyStore=this.$el.attr("value")}this._historyPosition++;this.$el.attr("value",e.at(this._historyPosition).get("command"))},historyDown:function(){if(this._historyPosition==-1){return}this._historyPosition--;if(this._historyPosition==-1){this.$el.attr("value",this._historyStore)}else{this.$el.attr("value",e.at(this._historyPosition).get("command"))}},validate:function(){this._historyPosition=-1;var o=this.$el.attr("value");e.push(o);this.trigger("input",o);this.$el.attr("value","");this.focus()},focus:function(){this.$el.focus()}});var g=l.View.extend({initialize:function(){this.setElement(f("#console-body"));n.bind("add",this.addOne,this);n.reset();this._initActions();f("#console-clean").click(this.clear.bind(this));this.prompt_=new j();this.prompt_.bind("input",this.compute,this)},_initActions:function(){this.actions=m.extend({clear:this.clear,help:this.help},b);this.actions.clear.help="Clear the screen";this.actions.help.help=["Usage : help [command]","help","   Show the list of functions","help command","   Show the help of the given command"].join("\n")},compute:function(o){n.create({level:"query",text:o});tokens=o.split(" ");if(!m.any(tokens)){return}if(tokens[0] in this.actions){result=this.actions[tokens.shift()].apply(this,tokens);if(result){n.create({level:"response",text:result})}}else{n.create({level:"notfound",text:'No such method "'+tokens[0]+'"'})}},gotJSON:function(p,o){n.create({level:"json",text:o})},addOne:function(p){var o=new i(p);this.$el.append(o.render().el);this.$el.scrollTop(this.$el.height())},clear:function(){this.$el.empty();this.show()},help:function(o){if(o&&o in this.actions){n.create({level:"help",text:this.actions[o].help})}else{n.create({level:"json",text:m.keys(this.actions)})}},show:function(){this.prompt_.focus()}});return g});define("napix-ui",["jQuery","Backbone","explorer","console","selectors","bootstrap"],function(e,g,b,c,d){var a=g.View.extend({el:"body",initialize:function(){this.explorer=new b();this.console=new c();this.selectors=new d();e("#explorer-label a").tab("show");e("#console-label a").bind("shown",this.console.show.bind(this.console))}});var f=g.Router.extend({initialize:function(){this.panels=new a();this.panels.explorer.bind("selected",this.navigate,this)},routes:{console:"showConsole","*path/":"goToPath","*path":"goToPath","/":"showConsole"},goToPath:function(h){this.panels.explorer.goToPath(h[0]!="/"&&"/"+h||h)}});return f});define("consoleactions",["underscore","napixclient","models/credentials","models/servers"],function(a,g,d,f){var c={};var b=function(l,h,k,i){var j=new e(l,h,k,i);return j.call.bind(j)};var e=function(k,h,j,i){this.filter=h;this.collection=k;this.usage=j;this.callbacks=i};e.prototype={call:function(){result=this.callback.apply(this,arguments);if(!result){return this.usage}},searchModel:function(h){return(this.collection.find(function(i){return i.get(this.filter)==h},this)||this.collection.find(function(i){return i.get(this.filter).search(h)!=-1},this))},callback:function(j,l){if(!j&&!l){return false}var k=l&&j||"choose";var i=a.rest(arguments,2);if(k=="add"&&l){i.unshift(l);return(this.callbacks.add||this.defaults.add).apply(this,i)}var h=this.searchModel(l||j);i.unshift(h);if(k=="choose"&&h){return(this.callbacks.choose||this.defaults.choose).apply(this,i)}else{if(k=="del"&&h){return(this.callbacks.del||this.defaults.del).apply(this,i)}}},defaults:{choose:function(h){h.select();return true},add:function(i){var h={};h[this.filter]=i;this.collection.create(h).select();return true},del:function(h){h.destroy();return true}}};c.login=b(d,"login","Usage: login [add|del|choose] username [password]",{choose:function(i,h){if(h&&i.get("pass")!=h){i.set({pass:h});i.save()}i.select();return true},add:function(h,i){console.log(h,i);if(i){d.create({login:h,pass:i}).select();return true}return false}});c.login.help=["Usage: login [add|del|choose] login [pass]","login username","login choose login","  Select the credentials which match login","login choose username pass","  Update te credentials matching username","login add username pass","  add the given credentials","login del username","  remove the credentials matching username"].join("\n");c.server=b(f,"host","Usage: server [add|del|choose] hostname",{});c.server.help=["Usage: server [add|del|choose] hostname","server hostname","server choose hostname","  Select the server which match hostname","server add hostname","  add the server at the host <hostname>","server del hostname","  remove the server matching hostname"].join("\n");c.GET=function(h){if(!h){return"Usage: GET url"}g.GET(h,a.bind(this.gotJSON,this,h))};c.GET.help=" Send a GET request a the given url";return c});define("selectors",["underscore","Backbone","jQuery","models/servers","models/credentials"],function(j,i,d,g,f){var c=i.View.extend({tagName:"li",initialize:function(){this.model.bind("change",this.render,this);this.model.bind("destroy",this.remove,this);this.$el.click(this.model.select.bind(this.model))},render:function(){this.$el.text(this.getText()).append(d("<i />",{"class":"icon-remove pull-right"}).click(this.model.destroy.bind(this.model)));if(this.model.get("selected")){this.$el.addClass("selected")}return this},remove:function(){this.$el.remove()}});var b=i.View.extend({initialize:function(){this.setElement(d("#"+this.prefix));this.collection.bind("reset",this.ensureDefault,this);this.collection.bind("reset",this.addAll,this);this.collection.bind("reset",this.selectDefault,this);this.hidePrompt();d("#"+this.prefix+"-plus .add").click(this.showPrompt.bind(this));d("#"+this.prefix+"-prompt").keypress(this.updateOnEnter.bind(this));d("#"+this.prefix+"-prompt .go").click(this.addOne.bind(this));d("#"+this.prefix+"-prompt .cancel").click(j.bind(this.trigger,this,"finished"));this.collection.fetch();this.collection.bind("add",this.addOne,this);this.bind("finished",this.hidePrompt,this)},selectDefault:function(){if(this.collection.size()&&!this.collection.any(function(m){return m.get("selected")})){this.collection.first().select()}},addAll:function(){this.collection.each(this.addOne,this)},addOne:function(m){m.bind("selected",this.select);this.$("#"+this.prefix+"-body").append(new this.ItemView({model:m}).render().el)},hidePrompt:function(){this.$("#"+this.prefix+"-prompt").hide();this.$("#"+this.prefix+"-plus").show()},showPrompt:function(){this.$("#"+this.prefix+"-prompt").show().first().find("input").attr("value","").focus();this.$("#"+this.prefix+"-plus").hide()},updateOnEnter:function(m){if(m.keyCode==13){this.addItem()}else{if(m.keyCode==27){this.trigger("finished")}}},addItem:function(){var m=j(this.$("input").toArray()).chain().map(function(o){return d(o)}).map(function(o){return[o.prop("name"),o.prop("value")]}).objectify().value();var n=this.collection.create(m);if(n){this.trigger("finished");n.select()}}});var k=c.extend({getText:function(){return this.model.get("host")}});var l=b.extend({collection:g,ItemView:k,prefix:"connections-servers",ensureDefault:function(){if(!this.collection.any(function(m){return m.get("host")==location.host})){this.collection.create({host:location.host})}}});var a=c.extend({getText:function(){return this.model.get("login")}});var e=b.extend({collection:f,ItemView:a,prefix:"connections-credentials",ensureDefault:function(){if(!this.collection.any(function(m){return m.get("pass")=="_napix_noauth"})){this.collection.create({login:"No auth (debug)",pass:"_napix_noauth"})}}});var h=i.View.extend({initialize:function(){this.serverSelector=new l();this.loginSelector=new e()}});return h});