require.config({paths:{bootstrap:"bootstrap.min",jQuery:"libs.min",underscore:"libs.min",Backbone:"libs.min",jsSHA:"libs.min",localstorage:"libs.min",selecteditem:"libs.min","json/editor":"json.min","json/viewer":"json.min","models/consoleentries":"models.min","models/history":"models.min","models/credentials":"models.min","models/servers":"models.min",napixclient:"models.min","libs/backbone/backbone":"libs/backbone.min","libs/underscore/underscore":"libs/underscore.min","libs/jquery/jquery":"libs/jquery.min","libs/jssha/sha256":"libs/sha256.min",mustache:"libs/mustache.min",selectors:"app.min",explorer:"app.min","napix-ui":"app.min",console:"app.min",consoleactions:"app.min",firstrun:"firstrun.min"}});define("libs/bootstrap/bootstrap-tooltip",["bootstrap"],function(){});define("libs/bootstrap/bootstrap-popover",["bootstrap"],function(){});define("main",["Backbone","jQuery","napix-ui"],function(e,b,d){var c=null;var a=function(){if(!c){c=new d();e.history.start()}return c};b(document).ready(a);return a});require(["main"]);define("explorer",["Backbone","jQuery","underscore","napixclient","json/viewer","json/editor","mustache"],function(g,j,t,n,b,e,d){var l=g.View.extend({tagName:"div",initialize:function(u,v){this.path=u;this.parentMetaData=v;if(t.isNull(v)){n.getLevel(this.path,this.gotMetaData.bind(this))}else{if(t.isString(v)){n.getLevel(v+"/"+(this.path.split("/").pop()),this.gotMetaData.bind(this))}else{if(v.direct_plug==true){n.getGenericLevel(this.path,this.gotMetaData.bind(this))}else{if(v.direct_plug==false){t.defer(this.gotMetaData.bind(this,v.absolute_url))}}}}},render:function(){j("<div />",{"class":"explorer-header"}).append(j("<i />",{"class":"deploy"})).append(j("<span />",{text:this.path,"class":"path"}).click(this.selectObject.bind(this))).appendTo(this.el);return this},getList:function(){n.GET(this.path+"/",this.gotList.bind(this))},gotList:function(v){var u=this.$(".explorer-content").first().empty();this.$(".deploy").first().addClass("icon-minus");this.contentViews=t(v).chain().filter(function(w){return w.search("/_napix")==-1}).sortBy(t.identity).map(function(x){var w=new l(x,this.metaData);w.bind("select",this.refire,this);u.append(w.render().el);return w},this).map(function(w){return[w.path,w]}).objectify().value();this.trigger("gotList",this.contentViews);this.unbind("gotList")},gotMetaData:function(u){this.metaData=u||null;j("<div />",{"class":"explorer-content"}).appendTo(this.el);this.$(".deploy").first().addClass("icon-plus").click(this.toggleContent.bind(this));this.trigger("gotMetaData");this.unbind("gotMetaData")},getObject:function(){if(!t.isString(this.parentMetaData)){n.GET(this.path,this.gotObject.bind(this))}else{this.gotObject()}},gotObject:function(u){if(u){this.object=u}this.trigger("select",this)},selectObject:function(){if(t.isUndefined(this.object)){this.object=null;this.getObject()}else{this.gotObject()}},toggleContent:function(v){if(!this.filled){this.filled=true;this.getList()}else{if(t.isBoolean(v)){this.$(".explorer-content").first().toggle(v);this.$(".deploy").first().addClass(v?"icon-plus":"icon-minus")}else{var u=this.$(".explorer-content").first().toggle().css("display")=="none";this.$(".deploy").first().addClass(u?"icon-plus":"icon-minus").removeClass(u?"icon-minus":"icon-plus")}}},refire:function(u){this.trigger("select",u)},setSelected:function(u){this.$(".explorer-header").first().toggleClass("selected",u)},refreshObject:function(){delete this.object;this.selectObject()},refreshContent:function(){this.filled=false;this.toggleContent()},goToPath:function(v){if(this.path==v){this.selectObject()}else{if(v.search(this.path)==0){if(this.metaData){this.toggleContent(true)}else{this.bind("gotMetaData",this.toggleContent.bind(this))}var u=function(w){t.any(w,function(x,y){if(v==y||v.search(y+"/")==0){x.goToPath(v);return true}return false})};if(this.contentViews){u(this.contentViews)}else{this.bind("gotList",u)}}}}});var q=g.View.extend({id:"explorer-root",initialize:function(){this.deployed=false},render:function(){this.$el.append(j("<div />",{text:"/"}).one("click",this.deploy.bind(this))).append(j("<div />",{"class":"explorer-content"}));return this},goToPath:function(v){this.deploy();var u=function(w){t.any(w,function(x,y){if(v.search(y)==0){x.goToPath(v);return true}return false})};if(this.views){u(this.views)}else{this.bind("gotList",u)}},deploy:function(){if(!this.deployed){n.GET("/",this.gotList.bind(this));this.deployed=true}},gotList:function(v){var u=this.$(".explorer-content");this.views=t(v).chain().map(function(x){var w=new l(x,null);w.bind("select",this.refire,this);u.append(w.render().el);return w},this).map(function(w){return[w.path,w]}).objectify().value();this.trigger("gotList",this.views);this.unbind("gotList")},refire:function(u){this.trigger("select",u)}});var o=g.View.extend({tagName:"em",render:function(){this.$el.text("empty");return this}});var p=g.View.extend({id:"",emptyView:o,initialize:function(){this.setElement(j("#"+this.id));this.shown=false;this.rendered=false;this.view=new this.emptyView();j("#"+this.id+"-label").bind("shown",this.show.bind(this)).bind("hidden",this.hide.bind(this))},gotObject:function(u){this.rendered=false;this.view=u?new this.insideView(u):new this.emptyView();return this.render()},render:function(){if(!this.rendered&&this.shown){this.rendered=true;this.actuallyRender()}return this},actuallyRender:function(){this.$el.empty().append(this.view.render().el);this.trigger("rendered",this.view)},available:function(u){j("#"+this.id+"-label").toggle(Boolean(u));if(!u){this.shown=false}},hide:function(){this.shown=false;return this},show:function(){this.shown=true;this.render();return this}});var k=p.extend({id:"explorer-object",insideView:b,gotObject:function(v,u){this.path=u.path;this.actions=u.actions;this.deletable=u.deletable;this.editable=u.editable;k.__super__.gotObject.call(this,v);return this},actuallyRender:function(){k.__super__.actuallyRender.call(this);var u=j("<div />",{id:"explorer-object-actions","class":"btn-group"}).appendTo(this.el);if(this.actions){t.each(this.actions,function(v){j("<button />",{text:v,"class":"btn"}).click(t.bind(this.trigger,this,"action",v,this.path)).appendTo(u)},this)}if(this.deletable){j("<button />",{text:"Delete","class":"btn btn-danger"}).click(t.bind(this.trigger,this,"delete",this.path)).appendTo(u)}if(this.editable){j("<button />",{text:"Edit","class":"btn"}).click(t.bind(this.trigger,this,"edit",this.path)).appendTo(u)}return this}});var m=p.extend({id:"explorer-help",insideView:b});var f=p.extend({insideView:e,initialize:function(){f.__super__.initialize.call(this);this.bind("rendered",this.onRender,this)},gotObject:function(v,u){this.path=u.path;f.__super__.gotObject.call(this,v)},onRender:function(u){u.bind("validate",t.bind(this.trigger,this,"validate",this.path))}});var a=f.extend({id:"explorer-edit"});var c=g.View.extend({initialize:function(u){this.collectionPath=u},render:function(){n.getNewObject(this.collectionPath,this.gotTemplate.bind(this));return this},gotTemplate:function(v){var u=new e(v,true);j(this.el).append(u.render().el);u.bind("validate",t.bind(this.trigger,this,"validate"))}});var i=f.extend({id:"explorer-create",insideView:c});var r=g.View.extend({className:"alert alert-info",initialize:function(v,u){this.path=v;this.action=u;this.actionUrl=this.path+"/_napix_action/"+this.action;this.optionnalView=null;this.mandatoryView=null},render:function(){n.GET(this.actionUrl+"/_napix_help",this.gotActionMetaData.bind(this));this.$el.empty().append(j("<h3 >",{text:this.path+" - "+this.action})).append(j("<a />",{"class":"close","data-dismiss":"alert",text:"X"}));return this},gotActionMetaData:function(u){var w=t.reduce(u.mandatory,function(y,x){y[x]="";return y},{});var v=j("<div />",{"class":"content json"});if(!t.isEmpty(w)){this.mandatoryView=new e.defaultView(w).disableAddKey();v.append(j("<h4 />",{text:"Mandatory parameters"})).append(this.mandatoryView.render().el)}if(!t.isEmpty(u.optional)){this.optionnalView=new e.defaultView(u.optional).disableAddKey();v.append(j("<h4 />",{text:"Optionnal parameters"})).append(this.optionnalView.render().el)}v.append(j("<button />",{text:"Valider","class":"btn validate"}).click(this.validate.bind(this)));this.$el.append(v);this.$("input,button.validate").first().focus()},validate:function(){n.POST(this.actionUrl,this.getValue(),this.gotResult.bind(this))},gotResult:function(u){this.$(".content").empty().append(new b(u).render().el)},getValue:function(){return t.extend(this.mandatoryView&&this.mandatoryView.getValue()||{},this.optionnalView&&this.optionnalView.getValue()||{})}});var s=g.View.extend({template:d.compile('{{#request.location}}<p> Path : {{.}} </p>{{/request.location}}<div id="{{alertId}}" class="accordion-group"> <a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-request" data-parent="#{{alertId}}" >Request Data</a><div id="{{alertId}}-request" class="accordion-body collapse"><div class="pre" ><strong>{{request.method}}</strong> {{request.host}} <a href="{{request.uri}}">{{request.uri}}</a> </div><div class="pre" ><div id="{{alertId}}-object" ></div> </div></div><a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-response" data-parent="#{{alertId}}" >Response Data</a><div id="{{alertId}}-response" class="accordion-body collapse"><p class="pre" ><strong>{{ response.status }}</strong> {{ response.statusText}}</p><pre>{{response.headers}}</pre></div></div>'),alertTemplate:d.compile('<div class="alert alert-block alert-{{level}}"><a href="#" class="close" data-dismiss="alert">X</a><h4>{{ text }}</h4></div>'),initialize:function(){this.setElement("#explorer-alerts");this.currentAlert=null},_alert:function(x,A,w,y){var v=j(this.alertTemplate({text:x,level:A}));var u={alertId:t.uniqueId("alert-"),request:w,response:{location:y.getResponseHeader("Location"),headers:y.getAllResponseHeaders(),status:y.status,statusText:y.statusText}};var z=j(this.template(u)).appendTo(v);if(w.data!=null){z.find("#"+u.alertId+"-object").replaceWith(new b(w.data).render().el)}return this._append(v)},done:function(v,u,w){this._alert(v,"info",u,w)},failed:function(v,x,y){var u=null;if(!v){v="Unknown error";u="If you use the Napix web interface to connect to another host you can not see the content of errors"}else{if(v.jQuery){u=v;v="An error occurred"}else{if(t.isObject(v)){u=new b(v).render().el;v="An error occurred"}}}var w=this._alert(v,"danger",x,y);if(u){j(w).find("h4").after(u)}},_append:function(v){if(this.currentAlert){var u=j(this.currentAlert).addClass("fade").addClass("in");t.delay(t.bind(u.alert,u,"close"),1500)}this.$el.append(v);this.currentAlert=v;return v}});var h=g.View.extend({initialize:function(){this.setElement(j("#explorer"));this.object=new k();this.help=new m();this.edit=new a();this.create=new i();this.edit.bind("validate",this.sendPUT,this);this.edit.available(false);this.create.bind("validate",this.sendPOST,this);this.object.bind("edit",this.showEdit,this).bind("delete",this.sendDELETE,this).bind("action",this.callAction,this).show();j('#explorer-tabs a[data-toggle="tab"]').bind("show",this.changeTab.bind(this));n.bind("change",this.selectServer,this);this.currentView=null;this.rootView=null;this.alert_=new s();n.bind("error",this.alert_.failed,this.alert_)},changeTab:function(u){j(u.relatedTarget).trigger("hidden")},showEdit:function(){j("#explorer-edit-label").tab("show")},goToPath:function(u){if(this.rootView){this.rootView.goToPath(u)}else{this.bind("selectServer",function(){this.rootView.goToPath(u)}.bind(this))}},selectServer:function(u){j("#server").text(u.getConnectionString());this.rootView=new q();this.rootView.bind("select",this.select,this);j("#explorer-server").empty().append(this.rootView.render().el);this.trigger("selectServer");this.unbind("selectServer")},select:function(u){if(this.currentView!=null){this.currentView.setSelected(false)}u.setSelected(true);this.create.available(u.metaData&&t.contains(u.metaData.collection_methods,"POST"));this.object.gotObject(u.object,{path:u.path,actions:u.parentMetaData&&u.parentMetaData.actions||[],editable:Boolean(u.parentMetaData&&t.contains(u.parentMetaData.resource_methods,"PUT")),deletable:Boolean(u.parentMetaData&&t.contains(u.parentMetaData.resource_methods,"DELETE"))});this.edit.gotObject(u.object,{path:u.path});this.help.gotObject(u.metaData&&!t.isString(u.metaData)?u.metaData:u.parentMetaData);this.create.gotObject(u.path,{path:u.path});j("#explorer-object-label").tab("show");this.currentView=u;this.trigger("selected",u.path)},sendPUT:function(v,u){n.PUT(v,u,function(x,w,y){this.currentView.refreshObject();this.alert_.done("Modified",w,y)}.bind(this))},sendPOST:function(v,u){n.POST(v+"/",u,function(x,w,y){this.currentView.refreshContent();this.alert_.done("Created",w,y);this.rootView.goToPath(y.getResponseHeader("Location"));j("#explorer-object-label").tab("show")}.bind(this))},sendDELETE:function(u){n.DELETE(u,function(w,v,x){this.rootView.bind("select",function(y){this.rootView.unbind("select",arguments.callee);y.refreshContent();y.selectObject()},this);this.goToPath(u.split("/").slice(0,-1).join("/"));this.alert_.done("Deleted",v,x)}.bind(this))},callAction:function(u,v){new r(v,u).render().$el.prependTo(this.el)}});return h});define("console",["Backbone","underscore","jQuery","json/viewer","models/history","models/consoleentries","consoleactions"],function(m,n,f,c,e,o,b){var i=m.View.extend({tagName:"div",className:"console-entry-text ",render:function(){f("<span />",{"class":"label"}).addClass(this.model.get("text")?"label-success":"label-danger").text(this.model.get("text")?"OK":"Fail").appendTo(this.$el);return this}});var a=m.View.extend({tagName:"div",className:"console-entry-text",render:function(){this.$el.text(this.model.get("text"));return this}});var d=a.extend({tagName:"pre"});var l=m.View.extend({className:"console-entry-query",render:function(){this.$el.append(f("<span />",{text:">>>"})).append(this.model.get("text"));return this}});var h=m.View.extend({render:function(){var p=this.model.get("text");this.$el.append(new c(p).render().el);return this}});var j=m.View.extend({initialize:function(p){this.inside=j.getView(p);this.setElement(this.inside.el)},render:function(){this.inside.render();this.$el.addClass("console-entry");return this}},{getView:function(p){if(p.get("level") in this.viewsMap){return new this.viewsMap[p.get("level")]({model:p})}return new this.defaultView({model:p})},viewsMap:{query:l,help:d,json:h,"boolean":i,},defaultView:a});var k=m.View.extend({initialize:function(){this.setElement(f("#console-input"));this.focus();this.keymap=this.getKeyMap();this.$el.keypress(this.onKeyPress.bind(this));f("#console-go").click(this.validate.bind(this));this._historyPosition=-1;this._historyStore=""},getKeyMap:function(){return{13:this.validate,38:this.historyUp,40:this.historyDown}},onKeyPress:function(p){var q=this.keymap[p.keyCode];if(q){q.call(this)}},historyUp:function(){if(!e.hasMore(this._historyPosition)){return}if(this._historyPosition==-1){this._historyStore=this.$el.attr("value")}this._historyPosition++;this.$el.attr("value",e.at(this._historyPosition).get("command"))},historyDown:function(){if(this._historyPosition==-1){return}this._historyPosition--;if(this._historyPosition==-1){this.$el.attr("value",this._historyStore)}else{this.$el.attr("value",e.at(this._historyPosition).get("command"))}},validate:function(){this._historyPosition=-1;var p=this.$el.attr("value");e.push(p);this.trigger("input",p);this.$el.attr("value","");this.focus()},focus:function(){this.$el.focus()}});var g=m.View.extend({initialize:function(){this.setElement(f("#console-body"));o.bind("add",this.addOne,this);o.reset();this._initActions();f("#console-clean").click(this.clear.bind(this));this.prompt_=new k();this.prompt_.bind("input",this.compute,this)},_initActions:function(){this.actions=n.extend({clear:this.clear,help:this.help},b);this.actions.clear.help="Clear the screen";this.actions.help.help=["Usage : help [command]","help","   Show the list of functions","help command","   Show the help of the given command"].join("\n")},compute:function(p){o.create({level:"query",text:p});tokens=p.split(" ");if(!n.any(tokens)){return}if(tokens[0] in this.actions){this.respond(this.actions[tokens.shift()].apply(this,tokens))}else{o.create({level:"notfound",text:'No such method "'+tokens[0]+'"'})}},respond:function(p){if(n.isUndefined(p)){return}if(n.isString(p)){o.create({level:"response",text:p})}else{if(n.isBoolean(p)){o.create({level:"boolean",text:p})}else{o.create({level:"json",text:p})}}},addOne:function(q){var p=new j(q);this.$el.append(p.render().el);this.$el.scrollTop(this.$el.height())},clear:function(){this.$el.empty();this.show()},help:function(p){if(p&&p in this.actions){o.create({level:"help",text:this.actions[p].help})}else{o.create({level:"json",text:n.keys(this.actions)})}},show:function(){this.prompt_.focus()}});return g});define("napix-ui",["jQuery","Backbone","explorer","console","selectors","bootstrap"],function(e,g,b,c,d){var a=g.View.extend({el:"body",initialize:function(){this.explorer=new b();this.console=new c();this.selectors=new d();e("#explorer-label a").tab("show");e("#console-label a").bind("shown",this.console.show.bind(this.console));e("#firstrun").click(function(){require(["firstrun"])})}});var f=g.Router.extend({initialize:function(){this.panels=new a();this.panels.explorer.bind("selected",this.navigate,this)},routes:{console:"showConsole","*path/":"goToPath","*path":"goToPath","/":"showConsole"},goToPath:function(h){this.panels.explorer.goToPath(h[0]!="/"&&"/"+h||h)}});return f});define("consoleactions",["underscore","napixclient","models/credentials","models/servers"],function(a,g,d,f){var c={};var b=function(l,h,k,i){var j=new e(l,h,k,i);return j.call.bind(j)};var e=function(k,h,j,i){this.filter=h;this.collection=k;this.usage=j;this.callbacks=a.extend(i,this.defaults)};e.prototype={call:function(){result=this.callback.apply(this,arguments);return result||this.usage},searchModel:function(h){return(this.collection.find(function(i){return i.get(this.filter)==h},this)||this.collection.find(function(i){return i.get(this.filter).search(h)!=-1},this))},callback:function(j,l){if(!(j in this.callbacks)){l=j;j="choose"}var k=j||"list";if(k=="help"){return false}var i=a.rest(arguments,2);if(k=="add"&&l){i.unshift(l);return this.callbacks.add.apply(this,i)}if(k=="list"){return this.callbacks[k].apply(this,i)}if(k=="choose"||k=="del"){var h=this.searchModel(l||j);i.unshift(h);if(h){return this.callbacks[k].apply(this,i)}}},defaults:{list:function(){return this.collection.map(function(h){return h.toString()})},choose:function(h){h.select();return true},add:function(i){var h={};h[this.filter]=i;this.collection.create(h).select();return true},del:function(h){h.destroy();return true}}};c.login=b(d,"login","Usage: login [add|del|choose|list] username [password]",{choose:function(i,h){if(h&&i.get("pass")!=h){i.set({pass:h});i.save()}i.select();return true},add:function(h,i){if(i){d.create({login:h,pass:i}).select();return true}return false}});c.login.help=["Usage: login [add|del|choose|list] login [pass]","login list","  List all the credentials","login username","login choose login","  Select the credentials which match login","login choose username pass","  Update te credentials matching username","login add username pass","  add the given credentials","login del username","  remove the credentials matching username"].join("\n");c.server=b(f,"host","Usage: server [add|del|choose|list] hostname",{});c.server.help=["Usage: server [add|del|choose|list] hostname","server list","  List all the servers","server hostname","server choose hostname","  Select the server which match hostname","server add hostname","  add the server at the host <hostname>","server del hostname","  remove the server matching hostname"].join("\n");c.GET=function(h){if(!h){return"Usage: GET url"}var i=this;g.GET(h,function(j){i.respond(j)},function(j){console.log(arguments);i.respond(j)})};c.GET.help=" Send a GET request a the given url";return c});define("selectors",["underscore","Backbone","jQuery","models/servers","models/credentials"],function(i,h,c,f,e){var b=h.View.extend({tagName:"li",initialize:function(){this.model.bind("change",this.setSelected,this);this.model.bind("destroy",this.remove,this);this.$el.click(this.model.select.bind(this.model))},render:function(){this.$el.text(this.model.toString()).append(c("<i />",{"class":"icon-remove pull-right"}).click(this.model.destroy.bind(this.model)));this.setSelected();return this},setSelected:function(){this.$el.toggleClass("selected",this.model.get("selected"))},remove:function(){this.$el.remove()}});var a=h.View.extend({ItemView:b,initialize:function(){this.setElement(c("#"+this.prefix));this.collection.bind("reset",this.ensureDefault,this);this.collection.bind("reset",this.addAll,this);this.collection.bind("reset",this.selectDefault,this);this.hidePrompt();c("#"+this.prefix+"-plus .add").click(this.showPrompt.bind(this));c("#"+this.prefix+"-prompt").keypress(this.updateOnEnter.bind(this));c("#"+this.prefix+"-prompt .go").click(this.addOne.bind(this));c("#"+this.prefix+"-prompt .cancel").click(i.bind(this.trigger,this,"finished"));this.collection.fetch();this.collection.bind("add",this.addOne,this);this.bind("finished",this.hidePrompt,this)},selectDefault:function(){if(this.collection.size()&&!this.collection.any(function(k){return k.get("selected")})){this.collection.first().select()}},addAll:function(){this.collection.each(this.addOne,this)},addOne:function(k){k.bind("selected",this.select);this.$("#"+this.prefix+"-body").append(new this.ItemView({model:k}).render().el)},hidePrompt:function(){this.$("#"+this.prefix+"-prompt").hide();this.$("#"+this.prefix+"-plus").show()},showPrompt:function(){this.$("#"+this.prefix+"-prompt").show().first().find("input").attr("value","").focus();this.$("#"+this.prefix+"-plus").hide()},updateOnEnter:function(k){if(k.keyCode==13){this.addItem()}else{if(k.keyCode==27){this.trigger("finished")}}},addItem:function(){var k=i(this.$("input").toArray()).chain().map(function(m){return c(m)}).map(function(m){return[m.prop("name"),m.prop("value")]}).objectify().value();var l=this.collection.create(k);if(l){this.trigger("finished");l.select()}}});var j=a.extend({collection:f,prefix:"connections-servers",ensureDefault:function(){if(!this.collection.any(function(k){return k.get("host")==location.host})){this.collection.create({host:location.host})}}});var d=a.extend({collection:e,prefix:"connections-credentials",ensureDefault:function(){if(!this.collection.any(function(k){return k.get("pass")=="_napix_noauth"})){this.collection.create({login:"No auth (debug)",pass:"_napix_noauth"})}}});var g=h.View.extend({initialize:function(){this.serverSelector=new j();this.loginSelector=new d()}});return g});