define("explorer",["Backbone","jQuery","underscore","napixclient","json/viewer","json/editor","mustache"],function(a,b,c,d,e,f,g){var h=a.View.extend({tagName:"div",initialize:function(a,b){this.path=a,this.parentMetaData=b,c.isNull(b)?d.getLevel(this.path,this.gotMetaData.bind(this)):c.isString(b)?d.getLevel(b+"/"+this.path.split("/").pop(),this.gotMetaData.bind(this)):b.direct_plug===!0?d.getGenericLevel(this.path,this.gotMetaData.bind(this)):b.direct_plug===!1&&c.defer(this.gotMetaData.bind(this,b.absolute_url)),this.$el.on("click","span.path",this.selectObject.bind(this))},template:g.compile('<div class="explorer-header"><i class="deploy"/><span class="path" >{{ . }}</span></div>'),render:function(){return this.$el.append(this.template(this.path)),this},getList:function(){d.GET(this.path+"/",this.gotList.bind(this))},gotList:function(a){var b=this.$(".explorer-content").first().empty();this.$(".deploy").first().addClass("icon-minus"),this.contentViews=c(a).chain().filter(function(a){return a.search("/_napix")===-1}).sortBy(c.identity).map(function(a){var c=new h(a,this.metaData);return c.bind("select",this.refire,this),b.append(c.render().el),c},this).map(function(a){return[a.path,a]}).objectify().value(),this.trigger("gotList",this.contentViews),this.unbind("gotList")},gotMetaData:function(a){this.metaData=a||null,b("<div />",{"class":"explorer-content"}).appendTo(this.el),this.$(".deploy").first().addClass("icon-plus").click(this.toggleContent.bind(this)),this.trigger("gotMetaData"),this.unbind("gotMetaData")},getObject:function(){c.isString(this.parentMetaData)?this.gotObject():d.GET(this.path,this.gotObject.bind(this))},gotObject:function(a){a&&(this.object=a),this.trigger("select",this)},selectObject:function(){return c.isUndefined(this.object)?(this.object=null,this.getObject()):this.gotObject(),!1},toggleContent:function(a){if(!this.filled)this.filled=!0,this.getList();else if(c.isBoolean(a))this.$(".explorer-content").first().toggle(a),this.$(".deploy").first().addClass(a?"icon-plus":"icon-minus");else{var b=this.$(".explorer-content").first().toggle().css("display")==="none";this.$(".deploy").first().addClass(b?"icon-plus":"icon-minus").removeClass(b?"icon-minus":"icon-plus")}},refire:function(a){this.trigger("select",a)},setSelected:function(a){this.$(".explorer-header").first().toggleClass("selected",a)},refreshObject:function(){delete this.object,this.selectObject()},refreshContent:function(){this.filled=!1,this.toggleContent()},goToPath:function(a){if(this.path===a)this.selectObject();else if(a.search(this.path)===0){this.metaData?this.toggleContent(!0):this.bind("gotMetaData",this.toggleContent.bind(this));var b=function(b){c.any(b,function(b,c){return a===c||a.search(c+"/")===0?(b.goToPath(a),!0):!1})};this.contentViews?b(this.contentViews):this.bind("gotList",b)}}}),i=a.View.extend({id:"explorer-root",initialize:function(){this.deployed=!1},render:function(){return this.$el.append('<div>/</div> <div class="explorer-content" />'),this},goToPath:function(a){this.deploy();var b=function(b){c.any(b,function(b,c){return a.search(c)===0?(b.goToPath(a),!0):!1})};this.views?b(this.views):this.bind("gotList",b)},deploy:function(){this.deployed||(d.GET("/",this.gotList.bind(this)),this.deployed=!0)},gotList:function(a){var b=this.$(".explorer-content");this.views=c(a).chain().map(function(a){var c=new h(a,null);return c.bind("select",this.refire,this),b.append(c.render().el),c},this).map(function(a){return[a.path,a]}).objectify().value(),this.trigger("gotList",this.views),this.unbind("gotList")},refire:function(a){this.trigger("select",a)}}),j=a.View.extend({tagName:"em",render:function(){return this.$el.text("empty"),this}}),k=a.View.extend({id:"",emptyView:j,initialize:function(){this.setElement(b("#"+this.id)),this.shown=!1,this.rendered=!1,this.view=new this.emptyView,b("#"+this.id+"-label").bind("shown",this.show.bind(this)).bind("hidden",this.hide.bind(this))},gotObject:function(a){return this.rendered=!1,this.view=a?new this.insideView(a):new this.emptyView,this.render()},render:function(){return!this.rendered&&this.shown&&(this.rendered=!0,this.actuallyRender()),this},actuallyRender:function(){this.$el.empty().append(this.view.render().el),this.trigger("rendered",this.view)},available:function(a){b("#"+this.id+"-label").toggle(Boolean(a)),a||(this.shown=!1)},hide:function(){return this.shown=!1,this},show:function(){return this.shown=!0,this.render(),this}}),l=k.extend({id:"explorer-object",insideView:e,events:{"click button":"buttonClicked"},gotObject:function(a,b){return this.path=b.path,this.actions=b.actions,this.deletable=b.deletable,this.editable=b.editable,l.__super__.gotObject.call(this,a),this},buttonClicked:function(a){this.trigger(a.target.dataset.event,this.path,a.target.dataset.action)},template:g.compile('<div id="explorer-object-actions" class="btn-group" >{{#deletable}}<button class="btn btn-danger" data-event="delete" >Delete</button>{{/deletable}}{{#editable}}<button class="btn" data-event="edit" >Edit</button>{{/editable}}{{#actions}}<button class="btn" data-event="action" data-action="{{.}}" >{{.}}</button>{{/actions}}</div>'),actuallyRender:function(){l.__super__.actuallyRender.call(this),this.$el.append(this.template(this))}}),m=k.extend({id:"explorer-help",insideView:e}),n=k.extend({insideView:f.FixedView,initialize:function(){n.__super__.initialize.call(this),this.bind("rendered",this.onRender,this)},gotObject:function(a,b){this.path=b.path,n.__super__.gotObject.call(this,a)},onRender:function(a){a.bind("validate",c.bind(this.trigger,this,"validate",this.path))}}),o=n.extend({id:"explorer-edit"}),p=a.View.extend({initialize:function(a){this.collectionPath=a},render:function(){return d.getNewObject(this.collectionPath,this.gotTemplate.bind(this)),this},gotTemplate:function(a){var d=new f.FixedView(a);b(this.el).append(d.render().el),d.bind("validate",c.bind(this.trigger,this,"validate"))}}),q=n.extend({id:"explorer-create",insideView:p}),r=a.View.extend({className:"alert alert-info",initialize:function(a,b){this.path=a,this.action=b,this.actionUrl=this.path+"/_napix_action/"+this.action,this.optionnalView=null,this.mandatoryView=null},events:{"click .validate":"validate","click .ok":"clear"},render:function(){return d.GET(this.actionUrl+"/_napix_help",this.gotActionMetaData.bind(this)),this.$el.empty().append(this.templateLoad(this)),this},templateLoad:g.compile('<a href="#" class="close" data-dismiss="alert" >X</a><h3>{{ path}} - {{ action }}</h3>'),template:g.compile('<div class="content json"><p>{{ doc }}</p>{{#mandatory}}<h4>Mandatory parameters</h4><div id="mandatory"></div>{{/mandatory}}{{#optional}}<h4>Optionnal parameters</h4><div id="optional"></div>{{/optional}}<button class="btn btn-primary validate">Validate</button></div>'),gotActionMetaData:function(a){var d=c.reduce(a.mandatory,function(a,b){return a[b]="",a},{}),e=b(this.template(a));c.isEmpty(d)||(this.mandatoryView=new f.FixedView.defaultView(d),e.find("#mandatory").replaceWith(this.mandatoryView.render().el)),c.isEmpty(a.optional)||(this.optionnalView=new f.FixedView.defaultView(a.optional),e.find("#optional").replaceWith(this.optionnalView.render().el)),this.$el.append(e),this.$("input,button.validate").first().focus()},validate:function(){d.POST(this.actionUrl,this.getValue(),this.gotResult.bind(this))},gotResult:function(a){this.$(".content").empty().append((new e(a)).render().el).append('<button class="btn ok" >Ok</button>')},clear:function(){return this.$el.alert("close"),!1},getValue:function(){return c.extend(this.mandatoryView?this.mandatoryView.getValue():{},this.optionnalView?this.optionnalView.getValue():{})}}),s=a.View.extend({template:g.compile('<div class="alert alert-block alert-{{level}}"><a href="#" class="close" data-dismiss="alert">X</a><h4 class="alert-heading">{{ text }}</h4>{{#location}}<p> Path : <a href="#{{location}}">{{location}}</a> </p>{{/location}}{{#retry}} <button id="{{alertId}}" class="btn retry btn-primary">Retry</button>{{/retry}}<div id="{{alertId}}" class="accordion-group"> <a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-request" data-parent="#{{alertId}}" >Request Data</a><div id="{{alertId}}-request" class="accordion-body collapse"><div class="pre" ><strong>{{request.method}}</strong> {{request.host}} <a href="{{request.uri}}">{{request.uri}}</a> </div>{{#request.data}}<div class="pre" ><div id="{{alertId}}-object" ></div> </div>{{/request.data}}</div><a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-response" data-parent="#{{alertId}}" >Response Data</a><div id="{{alertId}}-response" class="accordion-body collapse"><p class="pre" ><strong>{{ response.status }}</strong> {{ response.statusText}}</p><pre>{{response.headers}}</pre></div></div></div>'),events:{"click .retry":"retry"},initialize:function(){this.setElement("#explorer-alerts"),this.currentAlert=null,this.currentRequest=null},retry:function(){d.request(this.currentRequest),this._close(500)},_alert:function(a,d,f,g){this.currentRequest=d;var h=c.extend(g,{text:a,alertId:c.uniqueId("alert-"),request:d,response:{headers:f.getAllResponseHeaders(),status:f.status,statusText:f.statusText}}),i=b(this.template(h));return d.data!==null&&i.find("#"+h.alertId+"-object").replaceWith((new e(d.data)).render().el),this._append(i)},done:function(a,b,c){this._alert(a,b,c,{level:"success",location:c.getResponseHeader("Location")})},failed:function(a,d,f){var g=null;a?a.jquery?(g=a,a="An error occurred"):c.isObject(a)&&(g=(new e(a)).render().el,a="An error occurred"):(a="Unknown error",g="If you use the Napix web interface to connect to another host you can not see the content of errors");var h=this._alert(a,d,f,{level:"danger",retry:!0});g&&b(h).find("h4.alert-heading:first").after(b("<div />",{"class":"pre"}).append(g))},_close:function(a){if(this.currentAlert){var d=b(this.currentAlert).addClass("fade").addClass("in").addClass("alert-info").removeClass("alert-danger").removeClass("alert-success");c.delay(c.bind(d.alert,d,"close"),a||1500)}},_append:function(a){return this._close(),this.$el.prepend(a),this.currentAlert=a,a}}),t=a.View.extend({initialize:function(){this.setElement(b("#explorer")),this.object=new l,this.help=new m,this.edit=new o,this.create=new q,this.edit.bind("validate",this.sendPUT,this),this.edit.available(!1),this.create.bind("validate",this.sendPOST,this),this.object.bind("edit",this.showEdit,this).bind("delete",this.sendDELETE,this).bind("action",this.callAction,this).show(),b('#explorer-tabs a[data-toggle="tab"]').bind("show",this.changeTab.bind(this)),d.bind("change",this.selectServer,this),this.currentView=null,this.rootView=null,this.alert_=new s,d.bind("error",this.alert_.failed,this.alert_)},changeTab:function(a){b(a.relatedTarget).trigger("hidden")},showEdit:function(){b("#explorer-edit-label").tab("show")},goToPath:function(a){this.rootView?this.rootView.goToPath(a):this.bind("selectServer",function(){this.rootView.goToPath(a)}.bind(this))},selectServer:function(a){b("#server").text(a.getConnectionString()),this.rootView=new i,this.rootView.bind("select",this.select,this),b("#explorer-server").empty().append(this.rootView.render().el),this.rootView.deploy(),this.trigger("selectServer"),this.unbind("selectServer")},select:function(a){this.currentView!==null&&this.currentView.setSelected(!1),a.setSelected(!0),this.create.available(a.metaData&&c.contains(a.metaData.collection_methods,"POST")),this.object.gotObject(a.object,{path:a.path,actions:a.parentMetaData?a.parentMetaData.actions:[],editable:Boolean(a.parentMetaData&&c.contains(a.parentMetaData.resource_methods,"PUT")),deletable:Boolean(a.parentMetaData&&c.contains(a.parentMetaData.resource_methods,"DELETE"))}),this.edit.gotObject(a.object,{path:a.path}),this.help.gotObject(a.metaData&&!c.isString(a.metaData)?a.metaData:a.parentMetaData),this.create.gotObject(a.path,{path:a.path}),b("#explorer-object-label").tab("show"),this.currentView=a,this.trigger("selected",a.path)},sendPUT:function(a,b){d.PUT(a,b,function(a,b,c){this.currentView.refreshObject(),this.alert_.done("Modified",b,c)}.bind(this))},sendPOST:function(a,c){d.POST(a+"/",c,function(a,c,d){this.currentView.refreshContent(),this.alert_.done("Created",c,d),this.rootView.goToPath(d.getResponseHeader("Location")),b("#explorer-object-label").tab("show")}.bind(this))},sendDELETE:function(a){d.DELETE(a,function(b,c,d){this.rootView.bind("select",function(a){this.rootView.unbind("select",arguments.callee),a.refreshContent(),a.selectObject()},this),this.goToPath(a.split("/").slice(0,-1).join("/")),this.alert_.done("Deleted",c,d)}.bind(this))},callAction:function(a,b){(new r(a,b)).render().$el.prependTo(this.el)}});return t})