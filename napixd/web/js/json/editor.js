define(["Backbone","underscore","jQuery","json/viewer","libs/mustache","underscore-extensions"],function(a,b,c,d,e){var f=a.View.extend({tagName:"em",dataType:"null",initialize:function(a,b){this.originalValue=b},render:function(){return this.$el.text("null"),this},getValue:function(){return null}}),g=a.View.extend({tagName:"input",complex:!1,dataType:"boolean",initialize:function(a,b){this.originalValue=b,this.$el.prop("checked",a).prop("type","checkbox")},getValue:function(){return this.$el.prop("checked")}}),h=a.View.extend({tagName:"input",complex:!1,type:"text",dataType:"string",initialize:function(a,c){this.originalValue=c,this.$el.prop("type",this.type).prop("value",this._choose(a,c)).blur(b.bind(this.trigger,this,"change"))},_choose:function(a,c){var d=this._score(a),e=this._score(c);return!d&&!e?"":(a=d>=e?a:c,Math.max(d,e)>.25?a:b.first(a))},_score:function(a){return b.isString(a)?1:b.isNumber(a)?.75:b.isNull(a)||b.isBoolean(a)||b.isEmpty(a)?0:b.isArray(a)?.25:.25},getValue:function(){return this._getValue()},_getValue:function(){return this.$el.prop("value")}}),i=h.extend({type:"number",dataType:"number",getValue:function(){return Number(this._getValue())},_score:function(a){return b.isNumber(a)?1:b.isString(a)?.5:0}}),j=a.View.extend({complex:!0,initialize:function(a,c){this.originalValue=c;var a=this._choose(a,c);this.valueViews=b.map(b.keys(a),function(b){return this.makeView(a[b],b)},this)},_choose:function(a,b){var c=this._score(a),d=this._score(b);return!c&&!d?[]:(a=c>=d?a:b,Math.max(c,d)===.25?[a]:a)},render:function(){return b.each(this.valueViews,function(a){c("<li />").append(a.render().el).appendTo(this.el)},this),this},_score:function(a){return b.isNull(a)||b.isBoolean(a)||b.isUndefined(a)?0:b.isNumber(a)||b.isString(a)?.25:b.isArray(a)?.75+this.arrayBias*.25:1+this.arrayBias*.25}}),k=j.extend({addTextTemplate:e.compile('<li class="add-item" ><button class="btn btn-mini">{{ . }}</button></li>'),events:{"click .add-item":"addItem"},render:function(){return k.__super__.render.call(this),this._disabledAddKey||this.$el.append(this.addTextTemplate(this.addText)),this},removeKey:function(a){c(a.el).parent(this.$el.children("li")).remove(),this.valueViews=b.without(this.valueViews,a)},addItem:function(){var a=this.makeEmptyItem();return a.bind("pop",this.removeKey,this),this.valueViews.push(a),c("<li />").append(a.render().el).insertBefore(this.$el.children(".add-item")),!1},initialize:function(a,c){k.__super__.initialize.call(this,a,c),b.each(this.valueViews,function(a){a.bind("pop",this.removeKey,this)},this)}},{make:function(a,c){return b.extend(c,a),{FixedView:j.extend(a),EditView:k.extend(c)}}}),l=k.make({tagName:"ol",dataType:"array",arrayBias:1,makeView:function(a){return s.getView(a)},getValue:function(){return b.map(this.valueViews,function(a){return a.getValue()})}},{addText:"Add a row",makeEmptyItem:function(){return s.getView("")}}),m=k.make({tagName:"ul",dataType:"object",arrayBias:0,makeView:function(a,b){return new o(b,a)},getValue:function(){return b(this.valueViews).chain().map(function(a){return a.getValue()}).objectify().value()}},{addText:"Add a key",makeEmptyItem:function(){return new o("","")}}),n=a.View.extend({tagName:"label",initialize:function(a){this.editView=new h(a),this.editView.bind("change",this.update.bind(this))},update:function(){this.$el.empty().text(this.editView.getValue())},edit:function(){this.$el.text("").append(this.editView.el).focus()},render:function(){return this.$el.dblclick(this.edit.bind(this)),this.editView.getValue()===""?this.edit():this.update(),this},getValue:function(){return this.editView.getValue()}}),o=a.View.extend({tagName:"dd",initialize:function(a,b){this.keyView=new n(a),this.valueView=s.getView(b),this.valueView.bind("pop",this.trigger.bind(this,"pop",this))},render:function(){return this.$el.append(c("<dl />").append(this.keyView.render().el).append(":")).append(c("<dt />").append(this.valueView.render().el)),this},getValue:function(){return[this.keyView.getValue(),this.valueView.getValue()]}}),p=a.View.extend({tagName:"div",className:"json-multiedit",initialize:function(a){this.view=a.view},dataTypes:{"null":f,bool:g,number:i,string:h,array:l.EditView,object:o},template:'<div class="json-mte btn-group"><button class="btn btn-mini" data-type="null" >null</button><button class="btn btn-mini" data-type="bool" >bool</button><button class="btn btn-mini" data-type="string" >abc</button><button class="btn btn-mini" data-type="number" >123</button><button class="btn btn-mini" data-type="array" >[ ]</button><button class="btn btn-mini" data-type="object" >{ }</button><button class="btn btn-mini btn-danger" data-type="pop" >X</button/></div>',events:{"click button[data-type][data-type!='pop']":"onTranspose","click button[data-type='pop']":"pop"},render:function(){var a=c(this.template).appendTo(this.el);return a.find("[data-type='"+this.view.dataType+"']").addClass("active"),this.$el.append(this.view.render().el),this},getValue:function(){return this.view.getValue()},onTranspose:function(a){return this.transpose(a.target.dataset.type),!1},transpose:function(a){var b=this.dataTypes[a];this.view=new b(this.view.getValue(),this.view.originalValue),this.$el.empty(),this.render()},pop:function(){return this.trigger("pop",this),!1}}),q=a.View.extend({tagName:"textarea",initialize:function(a){this.value=a},render:function(){return this.$el.attr("value",JSON.stringify(this.value,null,4)),this},getValue:function(){return JSON.parse(this.el.value)}}),r=d.extend({className:"json-edit json",initialize:function(a){this.value=a,this.view=null,this.shown=""},getValue:function(){return this.view.getValue()},showText:function(){if(this.shown==="text")return;this.shown="text",this.updateValue(),this.view=new q(this.value),this.updateView()},showBuilder:function(){if(this.shown==="builder")return;this.shown="builder",this.updateValue(),this.view=this.constructor.getView(this.value),this.updateView()},updateValue:function(){this.value=this.view?this.view.getValue():this.value},updateView:function(){this.$(".json-edit-body").empty().append(this.view.render().el)},template:'<div class="json-edit-header btn-group" data-toggle="buttons-radio" ><button class="btn text">Text</button><button class="btn builder active" >Builder</button></div><div class="json-edit-body"> </div><div><button class="btn btn-primary validate" >Validate</button></div>',events:{"click .text":"showText","click .builder":"showBuilder","click .validate":"validate"},render:function(){return this.$el.append(this.template),this.showBuilder(),this},validate:function(){this.trigger("validate",this.getValue())}},{getView:function(a){var b=this.getViewClass.call(this,a);return new b(a,a)},viewsMap:[[b.isBoolean,g],[b.isNull,f],[b.isArray,l.FixedView],[b.isNumber,i],[b.isString,h]],defaultView:m.FixedView}),s=r.extend({},{getView:function(a){var b=s.__super__.constructor.getView.call(this,a);return new p({view:b})},viewsMap:[[b.isBoolean,g],[b.isNull,f],[b.isArray,l.EditView],[b.isNumber,i],[b.isString,h]],defaultView:m.EditView});return{EditView:s,FixedView:r,TextView:q,scalarViews:{"null":f,bool:g,number:i,string:h},specialViews:{key:n,item:o,multi:p},composedViews:{fixed:{object:m.FixedView,array:l.FixedView},edit:{object:m.EditView,array:l.EditView}}}})