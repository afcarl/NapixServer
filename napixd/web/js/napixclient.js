define(["Backbone","underscore","jQuery","models/servers","models/credentials","libs/jssha","ajax"],function(e,t,n,r,i,s,o){var u=function(e){this.suffix=e,this._resources={}};u.prototype={getResource:function(e,n){this._resources[e]&&t.isArray(this._resources[e])?this._resources[e].push(n):this._resources[e]?t.defer(n,this._resources[e]):(this._resources[e]=[n],f.GET(e+this.suffix,t.bind(this.gotResource,this,e)))},gotResource:function(e,n){t.each(this._resources[e],function(e){e(n)}),this._resources[e]=n},renew:function(){this._resources={}}};var a=function(e){this.blob=!0,this.xhr=e,this.xhr.onreadystatechange=t.bind(this._onreadystatechange,this),this.onreadystatechange=null,this._update()};a.prototype={responseType:"blob",_onreadystatechange:function(){this._update(),this.responseText=this.xhr.response,this.onreadystatechange&&this.onreadystatechange.apply(this.xhr,arguments)},_update:function(){t.map("status statusText readyState".split(" "),function(e){try{this[e]=this.xhr[e]}catch(t){}},this)},send:function(){return this.xhr.responseType=this.responseType,this.xhr.send.apply(this.xhr,arguments)}},t.map("abort open setRequestHeader getResponseHeader getAllResponseHeaders overrideMimeType".split(" "),function(e){a.prototype[e]=function(){return this.xhr[e].apply(this.xhr,arguments)}});var f={napix:null,_levels:new u("/_napix_help"),_newObjects:new u("/_napix_new"),_noAuth:!1,_server:null,_credentials:{},setConnection:function(e,t,n){return this._server=e,this._credentials={login:t,key:n},this._noAuth=n==="_napix_noauth",this},getConnectionString:function(){return this._credentials.login+"@"+this._server},make:function(){this._levels.renew(),this._newObjects.renew(),r.selected()&&i.selected()&&(this.setConnection(r.selected().get("host"),i.selected().get("login"),i.selected().get("pass")),this.trigger("change",this))},GET:function(e,t,n){this._request("GET",e,null,t,n)},HEAD:function(e,t,n){this._request("HEAD",e,null,t,n)},PUT:function(e,t,n,r){this._request("PUT",e,t,n,r)},POST:function(e,t,n,r){this._request("POST",e,t,n,r)},DELETE:function(e,t,n){this._request("DELETE",e,null,t,n)},proxySuccess:function(e){return function(t,n,r){e.success(t,e,r)}},proxyError:function(e){return t.bind(function(t,n,r){e.fail&&e.fail(r,e,t),this.onError(r,e,t)},this)},onError:function(e,n,r){if(r.responseText instanceof Blob){var i=r.getResponseHeader("content-type");if(i==="application/json"||i.indexOf("text/")===0||i==="application/xml"){var s=new FileReader;s.onload=t.bind(function(){this._launchError(s.result,r,n)},this),s.readAsText(r.responseText)}else this._launchError("",r,n)}else this._launchError(r.responseText,r,n)},_launchError:function(e,t,r){var i=t.getResponseHeader("content-type"),s;i==="application/json"?s=JSON.parse(e):i==="text/html"?s=n(e):s=e,this.trigger("error",s,r,t)},getLevel:function(e,t){return this._levels.getResource(e,t)},getNewObject:function(e,t){return this._newObjects.getResource(e,t)},getGenericLevel:function(e,t){var n=e.split("/");return n.pop(),n.push("*"),this.getLevel(n.join("/"),t)},sign:function(e,t){var n=new s(e,"ASCII");return n.getHMAC(t,"ASCII","SHA-256","HEX")},getAuthorization:function(e){return this._noAuth?"":this._getAuthorization(e)},_getAuthorization:function(e){var t={login:this._credentials.login,nonce:this.getNonce(),host:this._server,path:e.uri,method:e.method,timestamp:String(Math.floor(Date.now()/1e3))},n=this._encodeParams(t),r=this.sign(n,this._credentials.key);return n+":"+r},_encodeParams:function(e){var t=[],n;for(n in e)t.push(n+"="+encodeURIComponent(e[n]));return t.join("&")},getNonce:function(){return t.map(t.range(8),function(){return((1+Math.random())*65536|0).toString(16)}).join("")},_request:function(e,t,n,r,i){var s={method:e,uri:t,data:n,success:r,fail:i};this.request(s)},_getUrl:function(e){var t="http://"+this._server+e.uri;return this._noAuth&&(t+=(e.uri.indexOf("?")===-1?"?":"&")+"authok"),t},request:function(e){var r={url:this._getUrl(e),type:e.method,data:e.data&&JSON.stringify(e.data),dataType:"json",contentType:"application/json",success:this.proxySuccess(e),error:this.proxyError(e),xhr:e.blob&&function(){var e=n.ajaxSettings.xhr.call(this);return new a(e)},headers:{Authorization:this.getAuthorization(e)}};e.blob&&t.extend(r,{dataType:"*",converters:{"text xml":t.identity,"text json":t.identity}}),o.ajax(r)}};return t.extend(f,e.Events),r.bind("select",f.make,f),i.bind("select",f.make,f),f})