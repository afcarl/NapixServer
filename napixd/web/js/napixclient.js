define(["Backbone","underscore","jQuery","models/servers","models/credentials","libs/jssha","ajax","Date"],function(a,b,c,d,e,f,g,h){var i=function(a){return function(b,c,d){a.success(b,a,d)}},j=function(a,b){return function(c,d,e){a(e,b,c)}},k=function(a){this.suffix=a,this._resources={}};k.prototype={getResource:function(a,c){this._resources[a]&&b.isArray(this._resources[a])?this._resources[a].push(c):this._resources[a]?b.defer(c,this._resources[a]):(this._resources[a]=[c],l.GET(a+this.suffix,b.bind(this.gotResource,this,a)))},gotResource:function(a,c){b.each(this._resources[a],function(a){a(c)}),this._resources[a]=c},renew:function(){this._resources={}}};var l={napix:null,_levels:new k("/_napix_help"),_newObjects:new k("/_napix_new"),_noAuth:!1,_server:null,_credentials:{},setConnection:function(a,b,c){return this._server=a,this._credentials={login:b,key:c},this._noAuth=c==="_napix_noauth",this},getConnectionString:function(){return this._credentials.login+"@"+this._server},make:function(){this._levels.renew(),this._newObjects.renew(),d.selected()&&e.selected()&&(this.setConnection(d.selected().get("host"),e.selected().get("login"),e.selected().get("pass")),this.trigger("change",this))},GET:function(a,b,c){this._request("GET",a,null,b,c)},HEAD:function(a,b,c){this._request("HEAD",a,null,b,c)},PUT:function(a,b,c,d){this._request("PUT",a,b,c,d)},POST:function(a,b,c,d){this._request("POST",a,b,c,d)},DELETE:function(a,b,c){this._request("DELETE",a,null,b,c)},onError:function(a,b,d){this.trigger("error",d.getResponseHeader("content-type")==="application/json"&&JSON.parse(d.responseText)||d.getResponseHeader("content-type")==="text/html"&&c(d.responseText)||d.responseText,b,d)},getLevel:function(a,b){return this._levels.getResource(a,b)},getNewObject:function(a,b){return this._newObjects.getResource(a,b)},getGenericLevel:function(a,b){var c=a.split("/");return c.pop(),c.push("*"),this.getLevel(c.join("/"),b)},sign:function(a,b){var c=new f(a,"ASCII");return c.getHMAC(b,"ASCII","SHA-256","HEX")},getAuthorization:function(a){return this._noAuth?"":this._getAuthorization(a)},_getAuthorization:function(a){var b={login:this._credentials.login,nonce:this.getNonce(),host:a.host,path:a.uri,method:a.method,timestamp:String(Math.floor(h.now()/1e3))},c=this._encodeParams(b),d=this.sign(c,this._credentials.key);return c+":"+d},_encodeParams:function(a){var b=[],c;for(c in a)b.push(c+"="+escape(a[c]));return b.join("&")},getNonce:function(){return b.map(b.range(8),function(){return((1+Math.random())*65536|0).toString(16)}).join("")},_request:function(a,b,c,d,e){var f={method:a,uri:b,data:c,host:this._server,success:d,fail:e};this.request(f)},request:function(a){g.ajax({url:"http://"+a.host+a.uri+(this._noAuth?"?authok":""),type:a.method,data:a.data&&JSON.stringify(a.data),dataType:"json",contentType:"application/json",success:i(a),error:j(a.fail||this.onError.bind(this),a),headers:{Authorization:this.getAuthorization(a)}})}};return b.extend(l,a.Events),d.bind("select",l.make,l),e.bind("select",l.make,l),l})