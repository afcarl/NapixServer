define(["Backbone","jQuery","underscore","libs/mustache","napixclient","views/explorer/object","views/explorer/root","views/json/viewer","views/json/editor"],function(e,t,n,r,i,s,o,u,a){var f=e.View.extend({template:r.compile('<div class="alert alert-block alert-{{level}}"><a href="#" class="close" data-dismiss="alert">X</a><h4 class="alert-heading">{{ text }}</h4>{{#location}}<p> Path : <a href="#{{location}}">{{location}}</a> </p>{{/location}}{{#retry}} <button id="{{alertId}}" class="btn retry btn-primary">Retry</button>{{/retry}}<div id="{{alertId}}" class="accordion-group"> <a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-request" data-parent="#{{alertId}}" >Request Data</a><div id="{{alertId}}-request" class="accordion-body collapse"><div class="pre" ><strong>{{request.method}}</strong> {{request.host}} <a href="{{request.uri}}">{{request.uri}}</a> </div>{{#request.data}}<div class="pre" ><div id="{{alertId}}-object" ></div> </div>{{/request.data}}</div><a class="accordion-heading" data-toggle="collapse"data-target="#{{alertId}}-response" data-parent="#{{alertId}}" >Response Data</a><div id="{{alertId}}-response" class="accordion-body collapse"><p class="pre" ><strong>{{ response.status }}</strong> {{ response.statusText}}</p><pre>{{response.headers}}</pre></div></div></div>'),events:{"click .retry":"retry"},initialize:function(){this.setElement("#explorer-alerts"),this.currentAlert=null,this.currentRequest=null},retry:function(){i.request(this.currentRequest),this._close(500)},_alert:function(e,r,i,s){this.currentRequest=r;var o=n.extend(s,{text:e,alertId:n.uniqueId("alert-"),request:r,response:{headers:i.getAllResponseHeaders(),status:i.status,statusText:i.statusText}}),a=t(this.template(o));return r.data!==null&&a.find("#"+o.alertId+"-object").replaceWith((new u(r.data)).render().el),this._append(a)},done:function(e,t,n){this._alert(e,t,n,{level:"success",location:decodeURIComponent(n.getResponseHeader("Location"))})},failed:function(e,r,i){var s=null;e?e.jquery?(s=e,e="An error occurred"):n.isObject(e)&&(s=(new u(e)).render().el,e="An error occurred"):(e="Unknown error",s="If you use the Napix web interface to connect to another host you can not see the content of errors");var o=this._alert(e,r,i,{level:"danger",retry:!0});s&&t(o).find("h4.alert-heading:first").after(t("<div />",{"class":"pre"}).append(s))},_close:function(e){if(this.currentAlert){var r=t(this.currentAlert).addClass("fade").addClass("in").addClass("alert-info").removeClass("alert-danger").removeClass("alert-success");n.delay(n.bind(r.alert,r,"close"),e||1500)}},_append:function(e){return this._close(),this.$el.prepend(e),this.currentAlert=e,e}}),l=e.View.extend({className:"alert alert-info",initialize:function(e,t){this.path=e,this.action=t,this.actionUrl=this.path+"/_napix_action/"+this.action,this.optionnalView=null,this.mandatoryView=null},events:{"click .validate":"validate","click .ok":"clear"},render:function(){return i.GET(this.actionUrl+"/_napix_help",this.gotActionMetaData.bind(this)),this.$el.empty().append(this.templateLoad(this)),this},templateLoad:r.compile('<a href="#" class="close" data-dismiss="alert" >X</a><h3>{{ path}} - {{ action }}</h3>'),template:r.compile('<div class="content json"><p>{{ doc }}</p>{{#mandatory}}<h4>Mandatory parameters</h4><div id="mandatory"></div>{{/mandatory}}{{#optional}}<h4>Optionnal parameters</h4><div id="optional"></div>{{/optional}}<button class="btn btn-primary validate">Validate</button></div>'),gotActionMetaData:function(e){var r=n.reduce(e.mandatory,function(e,t){return e[t]="",e},{}),i=t(this.template(e));n.isEmpty(r)||(this.mandatoryView=new a.FixedView.defaultView(r),i.find("#mandatory").replaceWith(this.mandatoryView.render().el)),n.isEmpty(e.optional)||(this.optionnalView=new a.FixedView.defaultView(e.optional),i.find("#optional").replaceWith(this.optionnalView.render().el)),this.$el.append(i),this.$(":input,button.validate").first().focus()},validate:function(){i.POST(this.actionUrl,this.getValue(),this.gotResult.bind(this))},gotResult:function(e){this.$(".content").empty().append((new u(e)).render().el).append('<button class="btn ok" >Ok</button>')},clear:function(){return this.$el.alert("close"),!1},getValue:function(){return n.extend(this.mandatoryView?this.mandatoryView.getValue():{},this.optionnalView?this.optionnalView.getValue():{})}}),c=e.View.extend({events:{"click .refresh":"refreshObject"},initialize:function(){this.setElement(t("#explorer")),this.object=new s.ObjectView,this.help=new s.HelpView,this.edit=new s.EditView,this.create=new s.CreateView,this.edit.bind("validate",this.sendPUT,this),this.edit.available(!1),this.create.bind("validate",this.sendPOST,this),this.object.bind("edit",this.showEdit,this).bind("delete",this.sendDELETE,this).bind("action",this.callAction,this).show(),t('#explorer-tabs a[data-toggle="tab"]').bind("show",this.changeTab.bind(this)),i.bind("change",this.selectServer,this),this.currentView=null,this.rootView=null,this.alert_=new f,i.bind("error",this.alert_.failed,this.alert_)},changeTab:function(e){t(e.relatedTarget).trigger("hidden")},showEdit:function(){t("#explorer-edit-label").tab("show")},goToPath:function(e){this.rootView?this.rootView.goToPath(e):this.bind("selectServer",function(){this.rootView.goToPath(e)}.bind(this))},selectServer:function(e){t("#server").text(e.getConnectionString()),this.rootView=new o,this.rootView.bind("select",this.select,this),t("#explorer-server").empty().append(this.rootView.render().el),this.rootView.deploy(),this.trigger("selectServer"),this.unbind("selectServer")},select:function(e){this.currentView!==null&&this.currentView.setSelected(!1),e.setSelected(!0),this.create.available(e.metaData&&n.contains(e.metaData.collection_methods,"POST")),this.object.gotObject(e.object,{path:e.path,actions:e.parentMetaData?e.parentMetaData.actions:{},views:e.parentMetaData?e.parentMetaData.views:{},editable:Boolean(e.parentMetaData&&n.contains(e.parentMetaData.resource_methods,"PUT")),deletable:Boolean(e.parentMetaData&&n.contains(e.parentMetaData.resource_methods,"DELETE"))}),this.edit.gotObject(e.object,{path:e.path}),this.help.gotObject(e.metaData&&!n.isString(e.metaData)?e.metaData:e.parentMetaData),e.metaData&&this.create.gotObject(e.path,{path:e.path,resourceFields:e.metaData.resource_fields}),t("#explorer-object-label").tab("show"),this.currentView=e,this.trigger("selected",e.path)},sendPUT:function(e,t){i.PUT(e,t,function(e,t,n){this.currentView.refreshObject(),this.alert_.done("Modified",t,n)}.bind(this))},sendPOST:function(e,n){i.POST(e+"/",n,function(e,n,r){this.currentView.refreshContent(),this.alert_.done("Created",n,r),this.rootView.goToPath(r.getResponseHeader("Location")),t("#explorer-object-label").tab("show")}.bind(this))},sendDELETE:function(e){i.DELETE(e,function(t,n,r){var i=function(e){this.rootView.unbind("select",i),e.refreshContent(),e.selectObject()};this.rootView.bind("select",i,this),this.goToPath(e.split("/").slice(0,-1).join("/")),this.alert_.done("Deleted",n,r)}.bind(this))},refreshObject:function(){return this.currentView.refreshObject(),this.currentView.refreshContent(),!1},callAction:function(e,t){(new l(e,t)).render().$el.prependTo(this.el)}});return c})