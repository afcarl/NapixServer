define(["Backbone","underscore","jQuery","napixclient","libs/mustache"],function(e,t,n,r,i){var s=e.View.extend({tagName:"div",initialize:function(e,n){this.path=e,this.decodedPath=decodeURIComponent(e),this.parentMetaData=n,t.isNull(n)?r.getLevel(this.path,this.gotMetaData.bind(this)):t.isString(n)?r.getLevel(n+"/"+this.path.split("/").pop(),this.gotMetaData.bind(this)):n.direct_plug===!0?r.getGenericLevel(this.path,this.gotMetaData.bind(this)):n.direct_plug===!1&&t.defer(this.gotMetaData.bind(this,n.absolute_url)),this.$el.on("click","a.path",this.selectObject.bind(this))},template:i.compile('<div class="explorer-header"><i class="deploy"/><a class="path" href="{{path}}" >{{ decodedPath }}</a></div>'),render:function(){return this.$el.append(this.template(this)),this},getList:function(){r.GET(this.path+"/",this.gotList.bind(this))},gotList:function(e){var n=this.$(".explorer-content").first().empty();this.$(".deploy").first().addClass("icon-minus"),this.contentViews=t(e).chain().filter(function(e){return e.search("/_napix")===-1}).sortBy(t.identity).map(function(e){var t=new s(e,this.metaData);return t.bind("select",this.refire,this),n.append(t.render().el),t.resize(),t},this).map(function(e){return[e.path,e]}).objectify().value(),this.trigger("gotList",this.contentViews),this.unbind("gotList")},resize:function(){var e=null;while(this.$(".explorer-header").width()<this.$("a").width()){e=e||t.map(this.path.split("/"),decodeURIComponent),e.shift(),this.$(".path").first().text(".../"+e.join("/"));if(e.length===1)break}},gotMetaData:function(e){this.metaData=e||null,n("<div />",{"class":"explorer-content"}).appendTo(this.el),this.$(".deploy").first().addClass("icon-plus").click(this.toggleContent.bind(this)),this.trigger("gotMetaData"),this.unbind("gotMetaData")},getObject:function(){t.isString(this.parentMetaData)?this.gotObject():r.GET(this.path,this.gotObject.bind(this))},gotObject:function(e){e&&(this.object=e),this.trigger("select",this)},selectObject:function(){return t.isUndefined(this.object)?(this.object=null,this.getObject()):this.gotObject(),!1},toggleContent:function(e){if(!this.filled)this.filled=!0,this.getList();else if(t.isBoolean(e))this.$(".explorer-content").first().toggle(e),this.$(".deploy").first().addClass(e?"icon-plus":"icon-minus");else{var n=this.$(".explorer-content").first().toggle().css("display")==="none";this.$(".deploy").first().addClass(n?"icon-plus":"icon-minus").removeClass(n?"icon-minus":"icon-plus")}},refire:function(e){this.trigger("select",e)},setSelected:function(e){this.$(".explorer-header").first().toggleClass("selected",e)},refreshObject:function(){delete this.object,this.selectObject()},refreshContent:function(){if(t.isUndefined(this.metaData))return;this.filled=!1,this.toggleContent()},goToPath:function(e){if(this.path===e)this.selectObject();else if(e.search(this.path)===0){this.metaData?this.toggleContent(!0):this.bind("gotMetaData",this.toggleContent.bind(this));var n=function(n){t.any(n,function(t,n){return e===n||e.search(n+"/")===0?(t.goToPath(e),!0):!1})};this.contentViews?n(this.contentViews):this.bind("gotList",n)}}}),o=e.View.extend({id:"explorer-root",event:{"click .slash":"deploy"},initialize:function(){this.deployed=!1},render:function(){return this.$el.append('<div class="slash" >/</div> <div class="explorer-content" />'),this},goToPath:function(e){this.deploy();var n=function(n){t.any(n,function(t,n){return e.search(n)===0?(t.goToPath(e),!0):!1})};this.views?n(this.views):this.bind("gotList",n)},deploy:function(){this.deployed||(r.GET("/",this.gotList.bind(this),this.failedToGetList(this)),this.deployed=!0)},failedToGetList:function(){this.deployed=!1},gotList:function(e){var n=this.$(".explorer-content");this.views=t(e).chain().map(function(e){var t=new s(e,null);return t.bind("select",this.refire,this),n.append(t.render().el),t},this).map(function(e){return[e.path,e]}).objectify().value(),this.trigger("gotList",this.views),this.unbind("gotList")},refire:function(e){this.trigger("select",e)}});return o})