define(["Backbone","underscore","jQuery","libs/mustache","views/json/object","underscore-extensions"],function(e,t,n,r,i,s){var o=e.View.extend({tagName:"span",className:"label",events:{click:"reenable"},reenable:function(){this.trigger("reenable",this,this.view)},initialize:function(e){this.view=e.view},render:function(){return this.$el.text(this.view.getKey()),this}}),u=e.View.extend({complex:!0,initialize:function(e){this.finder=e.finder,this.originalValue=e.originalValue;var n=this._choose(e.value,e.originalValue),r,i;t.isArray(e.types)||t.isObject(e.types)?(r=e.types,i=t.keys(r)):(r={},i=t.keys(n)),this.valueViews=t.map(i,function(e){var t=this.makeView(n[e],e,r[e]);return t.bind("pop",this.removeKey,this),t},this),this.disabledViews=[]},getValue:function(){return t.chain(this.valueViews).difference(this.disabledViews).map(function(e){return e.getValue()}).value()},_choose:function(e,n){var r=this._score(e),i=this._score(n);return!r&&!i?[]:(e=r>=i?e:n,Math.max(r,i)===.25?this.arrayBias?[e]:{"":e}:this.arrayBias&&!t.isArray(e)?t.values(e):e)},render:function(){return t.each(this.valueViews,function(e){n("<li />").append(e.render().el).appendTo(this.el)},this),this},removeKey:function(e){this.disabledViews.push(e);var t=new o({view:e});t.render().$el.insertBefore(e.el),e.$el.detach(),t.bind("reenable",this.addKey)},addKey:function(e,n){this.disabledViews=t.without(e,n),e.$el.replaceWith(n.$el),e.unbind()},_score:function(e){return t.isNull(e)||t.isBoolean(e)||t.isUndefined(e)?0:t.isNumber(e)||t.isString(e)?.25:t.isArray(e)?.75+this.arrayBias*.25:1-this.arrayBias*.25}}),a=u.extend({addTextTemplate:r.compile('<li class="add-item" ><button tabindex="1" class="btn btn-mini">{{ . }}</button></li>'),events:{"click .add-item":"addItem"},render:function(){return a.__super__.render.call(this),this.$el.append(this.addTextTemplate(this.addText)),this},removeKey:function(e){n(e.el).parent(this.$el.children("li")).remove(),this.valueViews=t.without(this.valueViews,e)},addItem:function(){var e=this.makeEmptyItem();return e.bind("pop",this.removeKey,this),this.valueViews.push(e),n("<li />").append(e.render().el).insertBefore(this.$el.children(".add-item")).find(":input").not(".btn").first().focus(),!1}},{make:function(e,n,r){return n=t.extend({},e,n),{FixedView:u.extend(e,{detect:r}),EditView:a.extend(n,{detect:r})}}}),f=a.make({tagName:"ol",dataType:"array",arrayBias:1,makeView:function(e,t,n){return this.finder.getView(e,n)}},{addText:"Add a row",makeEmptyItem:function(){return this.finder.getView("")}},t.isArray),l=a.make({tagName:"ul",dataType:"object",arrayBias:0,ItemView:i.fixed,makeView:function(e,t,n){return new this.ItemView(t,this.finder.getView(e,n))},getValue:function(){return t.objectify(a.prototype.getValue.call(this))}},{addText:"Add a key",ItemView:i.edit,makeEmptyItem:function(){return new this.ItemView("",this.finder.getView(""))}},t.isObject);return{fixed:{object:l.FixedView,array:f.FixedView},edit:{object:l.EditView,array:f.EditView}}})