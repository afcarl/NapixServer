define(["Backbone","underscore","jQuery","views/json/viewer","libs/mustache","underscore-extensions"],function(e,t,n,r,i){var s=e.View.extend({tagName:"em",dataType:"null",initialize:function(e,t){this.originalValue=t},render:function(){return this.$el.text("null"),this},getValue:function(){return null}}),o=e.View.extend({tagName:"input",complex:!1,dataType:"boolean",attributes:{tabindex:1},initialize:function(e,t){this.originalValue=t,this.$el.prop("checked",e).prop("type","checkbox")},getValue:function(){return this.$el.prop("checked")}}),u=e.View.extend({complex:!1,initialize:function(e,t){this.originalValue=t},attributes:{tabindex:1},_choose:function(e,n){var r=this._score(e),i=this._score(n);return!r&&!i?"":(e=r>=i?e:n,Math.max(r,i)>.25?e:t.first(e))},_score:function(e){return t.isString(e)?1:t.isNumber(e)?.75:t.isNull(e)||t.isBoolean(e)||t.isEmpty(e)?0:t.isArray(e)?.25:.25}}),a=u.extend({tagName:"textarea",dataType:"string",attributes:{rows:1,tabindex:1},events:{keypress:"onKeyPress",blur:"triggerChange"},initialize:function(e,t){a.__super__.initialize(e,t),this.$el.text(this._choose(e,t)),this._setRows()},_setRows:function(){this.$el.attr("rows",this.getValue().split("\n").length)},onKeyPress:function(e){e.keyCode===13&&this._setRows()},triggerChange:function(){this.trigger("change")},getValue:function(){return this.$el.prop("value")}}),f=u.extend({attributes:{type:"number"},tagName:"input",dataType:"number",initialize:function(e,t){f.__super__.initialize(e,t),this.$el.prop("value",this._choose(e,t))},getValue:function(){return Number(this.$el.prop("value"))},_score:function(e){return t.isNumber(e)?1:t.isString(e)?.5:0}}),l=e.View.extend({complex:!0,initialize:function(e,n,r){this.originalValue=n,e=this._choose(e,n),this.valueViews=t.map(t.keys(e),function(t){return this.makeView(e[t],t,r&&r[t])},this)},_choose:function(e,t){var n=this._score(e),r=this._score(t);return!n&&!r?[]:(e=n>=r?e:t,Math.max(n,r)===.25?[e]:e)},render:function(){return t.each(this.valueViews,function(e){n("<li />").append(e.render().el).appendTo(this.el)},this),this},_score:function(e){return t.isNull(e)||t.isBoolean(e)||t.isUndefined(e)?0:t.isNumber(e)||t.isString(e)?.25:t.isArray(e)?.75+this.arrayBias*.25:1+this.arrayBias*.25}}),c=l.extend({addTextTemplate:i.compile('<li class="add-item" ><button tabindex="1" class="btn btn-mini">{{ . }}</button></li>'),events:{"click .add-item":"addItem"},render:function(){return c.__super__.render.call(this),this._disabledAddKey||this.$el.append(this.addTextTemplate(this.addText)),this},removeKey:function(e){n(e.el).parent(this.$el.children("li")).remove(),this.valueViews=t.without(this.valueViews,e)},addItem:function(){var e=this.makeEmptyItem();return e.bind("pop",this.removeKey,this),this.valueViews.push(e),n("<li />").append(e.render().el).insertBefore(this.$el.children(".add-item")).find(":input").not(".btn").first().focus(),!1},initialize:function(e,n){c.__super__.initialize.call(this,e,n),t.each(this.valueViews,function(e){e.bind("pop",this.removeKey,this)},this)}},{make:function(e,n){return t.extend(n,e),{FixedView:l.extend(e),EditView:c.extend(n)}}}),h=c.make({tagName:"ol",dataType:"array",arrayBias:1,makeView:function(e,t,n){return b.getView(e,n)},getValue:function(){return t.map(this.valueViews,function(e){return e.getValue()})}},{addText:"Add a row",makeEmptyItem:function(){return b.getView("","str")}}),p=c.make({tagName:"ul",dataType:"object",arrayBias:0,makeView:function(e,t,n){return new v(t,e,n)},getValue:function(){return t(this.valueViews).chain().map(function(e){return e.getValue()}).objectify().value()}},{addText:"Add a key",makeEmptyItem:function(){return new v("","","str")}}),d=e.View.extend({tagName:"label",initialize:function(e){this.editView=new a(e),this.editView.bind("change",this.update.bind(this))},update:function(){this.$el.empty().text(this.editView.getValue())},edit:function(){this.$el.text("").append(this.editView.el).focus()},render:function(){return this.$el.dblclick(this.edit.bind(this)),this.editView.getValue()===""?this.edit():this.update(),this},getValue:function(){return this.editView.getValue()}}),v=e.View.extend({tagName:"dd",initialize:function(e,t,n){this.keyView=new d(e),this.valueView=b.getView(t,n),this.valueView.bind("pop",this.trigger.bind(this,"pop",this))},render:function(){return this.$el.append(n("<dl />").append(this.keyView.render().el).append(":")).append(n("<dt />").append(this.valueView.render().el)),this},getValue:function(){return[this.keyView.getValue(),this.valueView.getValue()]}}),m=e.View.extend({tagName:"div",className:"json-multiedit",initialize:function(e){this.view=e.view},dataTypes:{"null":s,bool:o,number:f,string:a,array:h.EditView,object:v},template:'<div class="json-mte btn-group"><button class="btn btn-mini" tabindex="3" data-type="null" >null</button><button class="btn btn-mini" tabindex="3" data-type="bool" >bool</button><button class="btn btn-mini" tabindex="3" data-type="string" >abc</button><button class="btn btn-mini" tabindex="3" data-type="number" >123</button><button class="btn btn-mini" tabindex="3" data-type="array" >[ ]</button><button class="btn btn-mini" tabindex="3" data-type="object" >{ }</button><button class="btn btn-mini btn-danger" tabindex="3" data-type="pop" >X</button/></div>',events:{"click button[data-type][data-type!='pop']":"onTranspose","click button[data-type='pop']":"pop"},render:function(){var e=n(this.template).appendTo(this.el);return e.find("[data-type='"+this.view.dataType+"']").addClass("active"),this.$el.append(this.view.render().el),this},getValue:function(){return this.view.getValue()},onTranspose:function(e){return this.transpose(e.target.dataset.type),this.$(":input").focus(),!1},transpose:function(e){var t=this.dataTypes[e];this.view=new t(this.view.getValue(),this.view.originalValue),this.$el.empty(),this.render()},pop:function(){return this.trigger("pop",this),!1}}),g=e.View.extend({tagName:"textarea",className:"text-edit",initialize:function(e){this.value=e},render:function(){return this.$el.attr("value",JSON.stringify(this.value,null,4)),this},getValue:function(){return JSON.parse(this.el.value)}}),y=r.extend({className:"json-edit json",initialize:function(e,t){this.value=e,this.types=t,this.view=null,this.shown=""},getValue:function(){return this.view.getValue()},showText:function(){if(this.shown==="text")return;this.shown="text",this.updateValue(),this.view=new g(this.value),this.updateView()},showBuilder:function(){if(this.shown==="builder")return;this.shown="builder",this.updateValue(),this.view=this.constructor.getView(this.value,this.types),this.updateView()},updateValue:function(){this.value=this.view?this.view.getValue():this.value},updateView:function(){this.$(".json-edit-body").empty().append(this.view.render().el)},template:'<div class="json-edit-header btn-group" data-toggle="buttons-radio" ><button class="btn text">Text</button><button class="btn builder active" >Builder</button></div><div class="json-edit-body"> </div><div><button tabindex="2" class="btn btn-primary validate" >Validate</button></div>',events:{"click .text":"showText","click .builder":"showBuilder","click .validate":"validate"},render:function(){return this.$el.append(this.template),this.showBuilder(),this},validate:function(){this.trigger("validate",this.getValue())}},{getView:function(e,n){var r;return t.isNull(e)&&t.isString(n)?r=this.getViewClassByType.call(this,n):r=this.getViewClass.call(this,e),new r(e,e,n)},typesMap:{list:"array",dict:"object",str:"string",unicode:"string",set:"array"},getViewClassByType:function(e){return e=this.typesMap[e]||e,t.chain(this.viewsMap).map(function(e){return e[1]}).find(function(t){return t.prototype.dataType===e}).value()||this.getViewClass("")},viewsMap:[[t.isBoolean,o],[t.isNull,s],[t.isArray,h.FixedView],[t.isNumber,f],[t.isString,a]],defaultView:p.FixedView}),b=y.extend({},{getView:function(e,t){var n=b.__super__.constructor.getView.call(this,e,t);return new m({view:n})},viewsMap:[[t.isBoolean,o],[t.isNull,s],[t.isArray,h.EditView],[t.isNumber,f],[t.isString,a]],defaultView:p.EditView});return{EditView:b,FixedView:y,TextView:g,scalarViews:{"null":s,bool:o,number:f,string:a},specialViews:{key:d,item:v,multi:m},composedViews:{fixed:{object:p.FixedView,array:h.FixedView},edit:{object:p.EditView,array:h.EditView}}}})