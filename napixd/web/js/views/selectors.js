define(["underscore","Backbone","jQuery","models/servers","models/credentials","libs/mustache","napixclient"],function(e,t,n,r,i,s,o){var u=t.View.extend({tagName:"li",template:s.compile('<li ><a href="#">{{.}}</a><i class="icon-remove pull-right"/></li>'),initialize:function(){this.model.bind("change",this.setSelected,this),this.model.bind("destroy",this.remove,this),this.$el.on("click","a",this.model.select.bind(this.model)).on("click","i.icon-remove",this.model.destroy.bind(this.model))},render:function(){return this.$el.append(this.template(this.model.toString())),this.setSelected(),this},setSelected:function(){this.$el.toggleClass("selected",this.model.get("selected"))},remove:function(){this.$el.remove()}}),a=t.View.extend({ItemView:u,events:{"click .add":"showPrompt","click .plus":"showPrompt","keypress .prompt":"updateOnEnter","click .prompt .go":"addItem","click .prompt .cancel":"launchFinished"},initialize:function(){this.setElement(n("#"+this.prefix)),this.collection.bind("reset",this.ensureDefault,this),this.collection.bind("reset",this.addAll,this),this.collection.bind("reset",this.selectDefault,this),this.hidePrompt(),this.collection.fetch(),this.collection.bind("add",this.addOne,this),this.bind("finished",this.hidePrompt,this)},launchFinished:function(){this.trigger("finished")},selectDefault:function(){this.collection.size()&&!this.collection.any(function(e){return e.get("selected")})&&this.collection.first().select()},addAll:function(){this.collection.each(this.addOne,this)},addOne:function(e){e.bind("selected",this.select),this.$(".body").append((new this.ItemView({model:e})).render().el)},hidePrompt:function(){this.$(".prompt").hide(),this.$(".plus").show()},showPrompt:function(){this.$(".prompt").show().first().find("input").attr("value","").focus(),this.$("#"+this.prefix+"-plus").hide()},updateOnEnter:function(e){e.keyCode===13?this.addItem():e.keyCode===27&&this.trigger("finished")},addItem:function(){var t=e(this.$("input").toArray()).chain().map(function(e){return n(e)}).map(function(e){return[e.prop("name"),e.prop("value")]}).objectify().value(),r=this.collection.create(t);r&&(this.trigger("finished"),r.select())}}),f=a.extend({collection:r,prefix:"connections-servers",events:e.extend({"click .reload":"refresh"},a.prototype.events),refresh:function(e){if(n(e.target).hasClass("disabled"))return;o.GET("/_napix_reload",this.reEnable.bind(this)),this.$(".reload").addClass("disabled")},reEnable:function(){this.$(".reload").removeClass("disabled")},ensureDefault:function(){this.collection.any(function(e){return e.get("host")===location.host})||this.collection.create({host:location.host})}}),l=a.extend({collection:i,prefix:"connections-credentials",ensureDefault:function(){this.collection.any(function(e){return e.get("pass")==="_napix_noauth"})||this.collection.create({login:"No auth (debug)",pass:"_napix_noauth"})}}),c=t.View.extend({initialize:function(){this.serverSelector=new f,this.loginSelector=new l}});return c})