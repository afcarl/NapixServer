define(["underscore","Backbone","jQuery","models/servers","models/credentials","libs/mustache","underscore-extensions"],function(e,t,n,r,i,s){var o=t.View.extend({tagName:"li",template:s.compile('<li ><a href="#">{{.}}</a><i class="icon-remove pull-right"/></li>'),initialize:function(){this.model.bind("change",this.setSelected,this),this.model.bind("destroy",this.remove,this),this.$el.on("click","a",this.model.select.bind(this.model)).on("click","i.icon-remove",this.model.destroy.bind(this.model))},render:function(){return this.$el.append(this.template(this.model.toString())),this.setSelected(),this},setSelected:function(){this.$el.toggleClass("selected",this.model.get("selected"))},remove:function(){this.$el.remove()}}),u=t.View.extend({ItemView:o,initialize:function(){this.setElement(n("#"+this.prefix)),this.collection.bind("reset",this.ensureDefault,this),this.collection.bind("reset",this.addAll,this),this.collection.bind("reset",this.selectDefault,this),this.hidePrompt(),n("#"+this.prefix+"-plus .add").click(this.showPrompt.bind(this)),n("#"+this.prefix+"-prompt").keypress(this.updateOnEnter.bind(this)),n("#"+this.prefix+"-prompt .go").click(this.addItem.bind(this)),n("#"+this.prefix+"-prompt .cancel").click(e.bind(this.trigger,this,"finished")),this.collection.fetch(),this.collection.bind("add",this.addOne,this),this.bind("finished",this.hidePrompt,this)},selectDefault:function(){this.collection.size()&&!this.collection.any(function(e){return e.get("selected")})&&this.collection.first().select()},addAll:function(){this.collection.each(this.addOne,this)},addOne:function(e){e.bind("selected",this.select),this.$("#"+this.prefix+"-body").append((new this.ItemView({model:e})).render().el)},hidePrompt:function(){this.$("#"+this.prefix+"-prompt").hide(),this.$("#"+this.prefix+"-plus").show()},showPrompt:function(){this.$("#"+this.prefix+"-prompt").show().first().find("input").attr("value","").focus(),this.$("#"+this.prefix+"-plus").hide()},updateOnEnter:function(e){e.keyCode===13?this.addItem():e.keyCode===27&&this.trigger("finished")},addItem:function(){var t=e(this.$("input").toArray()).chain().map(function(e){return n(e)}).map(function(e){return[e.prop("name"),e.prop("value")]}).objectify().value(),r=this.collection.create(t);r&&(this.trigger("finished"),r.select())}}),a=u.extend({collection:r,prefix:"connections-servers",ensureDefault:function(){this.collection.any(function(e){return e.get("host")===location.host})||this.collection.create({host:location.host})}}),f=u.extend({collection:i,prefix:"connections-credentials",ensureDefault:function(){this.collection.any(function(e){return e.get("pass")==="_napix_noauth"})||this.collection.create({login:"No auth (debug)",pass:"_napix_noauth"})}}),l=t.View.extend({initialize:function(){this.serverSelector=new a,this.loginSelector=new f}});return l})